<!DOCTYPE html>
<!-- saved from url=(0151)file:///C:/Users/%ED%99%A9%EC%98%81%ED%98%84/Downloads/%EC%A1%B0%EA%B5%90_%EC%A0%95%EC%82%B0%EA%B4%80%EB%A6%AC_%EC%8B%9C%EC%8A%A4%ED%85%9C_fixed_5.html -->
<html lang="ko"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì¡°êµ ì •ì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<link href="./ì¡°êµ ì •ì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ_files/css2" rel="stylesheet">
<script src="./ì¡°êµ ì •ì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ_files/xlsx.full.min.js.ë‹¤ìš´ë¡œë“œ"></script>
<script type="module">
// â”€â”€â”€ Firebase ì´ˆê¸°í™” â”€â”€â”€
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update, remove }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCSDH7Nr5gkwlCktQEqhAGQVG_QuAvsUrQ",
  authDomain: "psj-edu-lab.firebaseapp.com",
  databaseURL: "https://psj-edu-lab-default-rtdb.firebaseio.com",
  projectId: "psj-edu-lab",
  storageBucket: "psj-edu-lab.firebasestorage.app",
  messagingSenderId: "577040388100",
  appId: "1:577040388100:web:68eb002b0a22496ac82551",
  measurementId: "G-1YMTNVMG1D"
};

const _app = initializeApp(firebaseConfig);
const _db  = getDatabase(_app);

// ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (ê¸°ì¡´ JS ì½”ë“œì—ì„œ ì‚¬ìš©)
window._fbDb  = _db;
window._fbRef = ref;
window._fbSet = set;
window._fbGet = get;
window._fbOnValue = onValue;
window._fbUpdate  = update;
window._fbRemove  = remove;

// Firebase ì¤€ë¹„ ì™„ë£Œ í›„ ì•± ì´ˆê¸°í™”
window.addEventListener('DOMContentLoaded', () => {
  window._firebaseReady = true;
  if(window._pendingInit) window._pendingInit();
});
</script>
<style>
:root {
  --bg:#0d0f14; --surface:#161922; --surface2:#1e2230; --border:#2a2f3d;
  --accent:#4f8ef7; --accent2:#7c5cfc; --success:#22c55e; --warning:#f59e0b;
  --danger:#ef4444; --text:#e8eaf0; --text2:#8b91a7; --text3:#545968;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans KR',sans-serif;min-height:100vh;}

/* LOGIN */
#login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:48px 44px;width:420px;max-width:95vw;}
.login-box h1{font-size:20px;font-weight:800;margin-bottom:6px;color:var(--accent);}
.login-box>p{font-size:13px;color:var(--text2);margin-bottom:28px;}
.login-tab-row{display:flex;gap:6px;margin-bottom:24px;}
.login-tab{flex:1;padding:9px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;text-align:center;border:1px solid var(--border);color:var(--text2);background:var(--bg);transition:all .15s;}
.login-tab.active{border-color:var(--accent);color:var(--accent);background:rgba(79,142,247,.1);}
.lform{display:flex;flex-direction:column;gap:14px;}
.lform .fl{display:flex;flex-direction:column;gap:6px;}
.lform .lbl{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;}
.lform input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:11px 14px;border-radius:10px;font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;transition:border-color .15s;}
.lform input:focus{border-color:var(--accent);}
.login-btn{width:100%;padding:12px;border-radius:10px;font-size:14px;font-weight:700;background:var(--accent);color:white;border:none;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:background .15s;}
.login-btn:hover{background:#3a7ae8;}
.lerr{font-size:12px;color:var(--danger);text-align:center;display:none;}
.lhint{font-size:11px;color:var(--text3);text-align:center;}

/* APP */
#app{display:none;}
#app.show{display:flex;min-height:100vh;}
.sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;position:sticky;top:0;height:100vh;overflow-y:auto;}
.sidebar-logo{padding:20px 20px 16px;border-bottom:1px solid var(--border);}
.sidebar-logo h1{font-size:14px;font-weight:700;color:var(--accent);}
.sidebar-logo p{font-size:11px;color:var(--text3);margin-top:3px;font-family:'Space Mono',monospace;}
.sidebar-user{margin:12px 12px 0;padding:10px 12px;background:var(--surface2);border-radius:8px;font-size:12px;color:var(--text2);display:flex;align-items:center;justify-content:space-between;}
.sidebar-user strong{color:var(--text);}
.logout-btn{font-size:11px;color:var(--text3);cursor:pointer;background:none;border:none;font-family:'Noto Sans KR',sans-serif;transition:color .15s;}
.logout-btn:hover{color:var(--danger);}
.sidebar-nav{padding:12px;flex:1;}
.nav-label{font-size:10px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;padding:0 8px;margin-bottom:6px;margin-top:14px;font-family:'Space Mono',monospace;}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;cursor:pointer;font-size:13.5px;color:var(--text2);transition:all .15s;font-weight:500;margin-bottom:2px;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:rgba(79,142,247,.12);color:var(--accent);}
.nav-icon{font-size:16px;width:20px;text-align:center;}
.main{flex:1;overflow-x:hidden;}
.page{display:none;padding:32px;}
.page.active{display:block;}

/* COMMON */
.page-header{margin-bottom:28px;}
.page-header h2{font-size:24px;font-weight:700;letter-spacing:-.5px;}
.page-header p{color:var(--text2);font-size:13px;margin-top:5px;}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;}
.stat-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;font-family:'Space Mono',monospace;margin-bottom:8px;}
.stat-value{font-size:26px;font-weight:700;font-family:'Space Mono',monospace;color:var(--text);}
.stat-sub{font-size:11px;color:var(--text3);margin-top:4px;}
.stat-card.accent .stat-value{color:var(--accent);}
.stat-card.success .stat-value{color:var(--success);}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:20px;}
.card-title{font-size:14px;font-weight:700;margin-bottom:18px;color:var(--text);display:flex;align-items:center;justify-content:space-between;}
.form-row{display:grid;gap:14px;margin-bottom:14px;}
.form-row.c2{grid-template-columns:1fr 1fr;}
.form-row.c3{grid-template-columns:1fr 1fr 1fr;}
.form-row.c4{grid-template-columns:1fr 1fr 1fr 1fr;}
.form-group{display:flex;flex-direction:column;gap:6px;}
label{font-size:11px;color:var(--text2);font-weight:500;text-transform:uppercase;letter-spacing:.8px;}
input,select,textarea{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:8px;font-size:13px;font-family:'Noto Sans KR',sans-serif;outline:none;transition:border-color .15s;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);}
select option{background:var(--surface2);}
textarea{resize:vertical;min-height:72px;}
.btn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .15s;font-family:'Noto Sans KR',sans-serif;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(--accent);color:white;}
.btn-primary:hover{background:#3a7ae8;}
.btn-secondary{background:var(--surface2);color:var(--text2);border:1px solid var(--border);}
.btn-secondary:hover{color:var(--text);border-color:var(--text2);}
.btn-danger{background:transparent;color:var(--danger);border:1px solid var(--danger);}
.btn-danger:hover{background:var(--danger);color:white;}
.btn-purple{background:rgba(124,92,252,.15);color:var(--accent2);border:1px solid rgba(124,92,252,.3);}
.btn-purple:hover{background:var(--accent2);color:white;}
.btn-sm{padding:5px 11px;font-size:12px;}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th{text-align:left;padding:10px 14px;background:var(--surface2);color:var(--text3);font-size:11px;text-transform:uppercase;letter-spacing:.8px;font-weight:600;font-family:'Space Mono',monospace;white-space:nowrap;}
th:first-child{border-radius:8px 0 0 8px;}th:last-child{border-radius:0 8px 8px 0;}
td{padding:11px 14px;border-bottom:1px solid var(--border);color:var(--text);white-space:nowrap;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.02);}
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:100px;font-size:11px;font-weight:600;font-family:'Space Mono',monospace;}
.badge-blue{background:rgba(79,142,247,.15);color:var(--accent);}
.badge-green{background:rgba(34,197,94,.15);color:var(--success);}
.badge-purple{background:rgba(124,92,252,.15);color:var(--accent2);}
.badge-orange{background:rgba(245,158,11,.15);color:var(--warning);}
.search-bar{display:flex;gap:10px;margin-bottom:18px;align-items:center;}
.search-bar input{flex:1;}
.amount-display{font-family:'Space Mono',monospace;font-size:13px;color:var(--success);font-weight:700;}
.amount-before{font-family:'Space Mono',monospace;font-size:13px;color:var(--text2);}
.tax-badge{font-size:10px;color:var(--warning);background:rgba(245,158,11,.1);padding:2px 6px;border-radius:4px;font-family:'Space Mono',monospace;}
.divider{height:1px;background:var(--border);margin:20px 0;}
.rate-chip{display:inline-flex;align-items:center;padding:2px 8px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2);border-radius:6px;font-size:11px;font-weight:700;color:var(--success);font-family:'Space Mono',monospace;}
.admin-banner{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:10px;padding:14px 18px;margin-bottom:18px;font-size:13px;color:var(--warning);}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:600px;max-width:95vw;max-height:90vh;overflow-y:auto;}
.modal-lg{width:760px;}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:22px 24px;border-bottom:1px solid var(--border);}
.modal-header h3{font-size:16px;font-weight:700;}
.modal-close{background:none;border:none;color:var(--text3);cursor:pointer;font-size:20px;line-height:1;transition:color .15s;}
.modal-close:hover{color:var(--text);}
.modal-body{padding:24px;}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;}

/* NOTIF */
.notif{position:fixed;top:24px;right:24px;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;display:none;animation:slideIn .3s ease;}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}

/* MAMAKO CALC */
.mamako-section{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;}
.mamako-section-title{font-size:12px;font-weight:700;color:var(--accent2);text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.mamako-result-box{background:rgba(124,92,252,.08);border:1px solid rgba(124,92,252,.2);border-radius:10px;padding:16px;}
.big-result{font-size:36px;font-weight:900;font-family:'Space Mono',monospace;color:var(--accent2);}
.result-line{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;}
.result-line:last-child{border-bottom:none;}
.result-line .label{color:var(--text2);}
.result-line .val{font-family:'Space Mono',monospace;font-weight:700;color:var(--text);}
.result-line.total-line .label{color:var(--success);font-weight:700;}
.result-line.total-line .val{color:var(--success);font-size:16px;}

/* NUMBER INPUT GROUP */
.num-input-group{display:flex;align-items:center;gap:8px;}
.num-input-group input{width:90px;text-align:center;}
.num-input-group .unit{font-size:12px;color:var(--text2);white-space:nowrap;}

/* WORK TYPE SELECTOR */
.type-pills{display:flex;gap:6px;flex-wrap:wrap;}
.type-pill{padding:6px 14px;border-radius:20px;cursor:pointer;font-size:12px;font-weight:600;border:1px solid var(--border);color:var(--text2);background:var(--bg);transition:all .15s;white-space:nowrap;}
.type-pill:hover{border-color:var(--accent);color:var(--accent);}
.type-pill.sel-ta{border-color:var(--accent);color:var(--accent);background:rgba(79,142,247,.1);}
.type-pill.sel-mamako{border-color:var(--accent2);color:var(--accent2);background:rgba(124,92,252,.1);}
.type-pill.sel-lab{border-color:var(--success);color:var(--success);background:rgba(34,197,94,.1);}
.type-pill.sel-qa{border-color:var(--warning);color:var(--warning);background:rgba(245,158,11,.1);}
</style>
</head>
<body>

<div class="notif" id="notif"></div>

<!-- â•â•â• LOGIN â•â•â• -->
<div id="login-screen" style="display: flex;">
  <div class="login-box">
    <h1>ì¡°êµ ì •ì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
    <p>ì—­í• ì„ ì„ íƒí•˜ê³  ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
    <div class="login-tab-row">
      <div class="login-tab active" id="tab-admin" onclick="switchTab(&#39;admin&#39;)">ğŸ”‘ ê´€ë¦¬ì</div>
      <div class="login-tab" id="tab-member" onclick="switchTab(&#39;member&#39;)">ğŸ‘¤ ì¡°êµ</div>
    </div>
    <div id="pane-admin" class="lform">
      <div class="fl"><span class="lbl">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</span><input type="password" id="admin-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeydown="if(event.key===&#39;Enter&#39;)doAdminLogin()"></div>
      <p class="lerr" id="admin-err">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>
      <button class="login-btn" onclick="doAdminLogin()">ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸</button><p></p>
    </div>
    <div id="pane-member" class="lform" style="display:none;">
      <div class="fl">
        <span class="lbl">ê°œì¸ PIN ë²ˆí˜¸</span>
        <input type="password" id="member-pin-input" placeholder="PIN ë²ˆí˜¸ ì…ë ¥" maxlength="8" inputmode="numeric" style="font-family:&#39;Space Mono&#39;,monospace;letter-spacing:4px;font-size:20px;text-align:center;" onkeydown="if(event.key===&#39;Enter&#39;)doMemberLogin()">
      </div>
      <p class="lerr" id="member-err">PIN ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <button class="login-btn" onclick="doMemberLogin()">ë¡œê·¸ì¸</button>
      <p class="lhint">ê´€ë¦¬ìì—ê²Œ ë°œê¸‰ë°›ì€ PIN ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
    </div>
  </div>
</div>

<!-- â•â•â• APP â•â•â• -->
<div id="app">
  <div class="sidebar">
    <div class="sidebar-logo"><h1>ì¡°êµ ì •ì‚°ê´€ë¦¬</h1><p>TA Settlement System</p></div>
    <div class="sidebar-user"><span id="sidebar-who"></span><button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button></div>
    <nav class="sidebar-nav">
      <div class="nav-label admin-only">ë©”ë‰´</div>
      <div class="nav-item admin-only active" data-page="dashboard" onclick="showPage(&#39;dashboard&#39;,this)"><span class="nav-icon">ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ</div>
      <div class="nav-item admin-only" data-page="work" onclick="showPage(&#39;work&#39;,this)"><span class="nav-icon">ğŸ“</span> ì—…ë¬´ë‚´ì—­ ë³´ê³ </div>
      <div class="nav-item admin-only" data-page="settlement" onclick="showPage(&#39;settlement&#39;,this)"><span class="nav-icon">ğŸ’°</span> ì›”ë³„ ì •ì‚°í˜„í™©</div>
      <div class="nav-item admin-nav" data-page="members" onclick="showPage(&#39;members&#39;,this)"><span class="nav-icon">ğŸ‘¥</span> ì¸ì ì‚¬í•­ ê´€ë¦¬</div>
      <div class="nav-label member-nav" style="display:none;">ë‚´ ë©”ë‰´</div>
      <div class="nav-item member-nav" data-page="member-home" onclick="showPage(&#39;member-home&#39;,this)" style="display:none;"><span class="nav-icon">ğŸ </span> í™ˆ</div>
      <div class="nav-label admin-only">ê³„ì‚°ê¸°</div>
      <div class="nav-item admin-only" data-page="mamako-calc" onclick="showPage(&#39;mamako-calc&#39;,this)"><span class="nav-icon">ğŸ§®</span> ì •ì‚° ê³„ì‚°ê¸°</div>
      <div class="nav-label admin-nav">ë„êµ¬</div>
      <div class="nav-item admin-nav" onclick="openSettings()"><span class="nav-icon">âš™ï¸</span> ì‹œìŠ¤í…œ ì„¤ì •</div>
      <div class="nav-item admin-nav" onclick="openExportModal()"><span class="nav-icon">ğŸ“Š</span> ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</div>
    </nav>
  </div>

  <div class="main">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="page-header"><h2>ëŒ€ì‹œë³´ë“œ</h2><p id="dash-sub">ì „ì²´ í˜„í™© ìš”ì•½</p></div>
      <div class="stats-row">
        <div class="stat-card accent"><div class="stat-label">ì´ ì¡°êµ ìˆ˜</div><div class="stat-value" id="s-members">0</div><div class="stat-sub">ë“±ë¡ëœ ì¡°êµ</div></div>
        <div class="stat-card"><div class="stat-label">ì´ë²ˆ ë‹¬ ë³´ê³  ê±´ìˆ˜</div><div class="stat-value" id="s-count">0</div><div class="stat-sub">ê±´</div></div>
        <div class="stat-card success"><div class="stat-label">ì´ë²ˆ ë‹¬ ì„¸ì „ ì´ì•¡</div><div class="stat-value" id="s-before">0</div><div class="stat-sub">ì›</div></div>
        <div class="stat-card"><div class="stat-label">ì´ë²ˆ ë‹¬ ì„¸í›„ ì´ì•¡</div><div class="stat-value" id="s-net">0</div><div class="stat-sub">ì› (ê³µì œ í›„)</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div class="card"><div class="card-title">ìµœê·¼ ì—…ë¬´ ë³´ê³ </div>
          <div class="table-wrap"><table><thead><tr><th>ë‚ ì§œ</th><th>ì´ë¦„</th><th>ìœ í˜•</th><th>ì‹œê°„</th><th>ê¸ˆì•¡(ì„¸ì „)</th></tr></thead><tbody id="recent-tbody"></tbody></table></div>
        </div>
        <div class="card"><div class="card-title">ì´ë²ˆ ë‹¬ ì¡°êµë³„ í˜„í™©</div>
          <div class="table-wrap"><table><thead><tr><th>ì´ë¦„</th><th>ì‹œê°„</th><th>ì„¸ì „</th><th>ì„¸í›„</th></tr></thead><tbody id="summary-tbody"></tbody></table></div>
        </div>
      </div>
    </div>

    <!-- WORK -->
    <div class="page" id="page-work">
      <div class="page-header"><h2>ì—…ë¬´ë‚´ì—­ ë³´ê³ </h2><p>ì¡°êµë³„ ì—…ë¬´ ì‹œê°„ ë° ê¸ˆì•¡ ê¸°ë¡</p></div>
      <div class="card">
        <div class="card-title">ì—…ë¬´ ë‚´ì—­ <button class="btn btn-primary btn-sm admin-el" onclick="openAddWork()">+ ì¶”ê°€</button></div>
        <div class="search-bar">
          <input type="text" id="w-search" placeholder="ì´ë¦„, ë‚ ì§œ, ë‚´ìš© ê²€ìƒ‰..." oninput="renderWork()">
          <select id="w-month" onchange="renderWork()"><option value="">ì „ì²´ ì›”</option></select>
          <select id="w-name-f" class="admin-el" onchange="renderWork()"><option value="">ì „ì²´ ì¡°êµ</option></select>
        </div>
        <div class="table-wrap">
          <table><thead><tr><th>ë‚ ì§œ</th><th>ì´ë¦„</th><th>ìœ í˜•</th><th>ìƒì„¸ë‚´ìš©</th><th>ì‹œê°„</th><th>ì‹œê¸‰</th><th>ê¸ˆì•¡(ì„¸ì „)</th><th>ë¹„ê³ </th><th class="admin-el">ê´€ë¦¬</th></tr></thead>
          <tbody id="work-tbody"></tbody></table>
        </div>
        <div style="margin-top:12px;"><span id="work-info" style="font-size:12px;color:var(--text3);"></span></div>
      </div>
    </div>

    <!-- SETTLEMENT -->
    <div class="page" id="page-settlement">
      <div class="page-header"><h2>ì›”ë³„ ì •ì‚°í˜„í™©</h2><p>ì›”ë³„ ì •ì‚° ë‚´ì—­ í™•ì¸</p></div>
      <div class="card">
        <div class="card-title">
          ì •ì‚° ì›” ì„ íƒ
          <div style="display:flex;gap:10px;">
            <select id="sy" onchange="renderSettlement()"></select>
            <select id="sm" onchange="renderSettlement()"></select>
            <button class="btn btn-sm btn-secondary admin-el" onclick="exportSettlementXlsx()">ğŸ“Š ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
          </div>
        </div>
        <div class="stats-row" style="grid-template-columns:repeat(3,1fr);">
          <div class="stat-card accent"><div class="stat-label">ì„¸ì „ í•©ê³„</div><div class="stat-value" id="st-before">0</div><div class="stat-sub">ì›</div></div>
          <div class="stat-card"><div class="stat-label">ê³µì œì•¡</div><div class="stat-value" id="st-tax" style="color:var(--warning);">0</div><div class="stat-sub">ì›</div></div>
          <div class="stat-card success"><div class="stat-label">ì„¸í›„ ì§€ê¸‰ì•¡</div><div class="stat-value" id="st-net">0</div><div class="stat-sub">ì›</div></div>
        </div>
        <div class="table-wrap">
          <table><thead><tr><th>#</th><th>ì´ë¦„</th><th>ì´ ì‹œê°„</th><th>ì„¸ì „ ê¸ˆì•¡</th><th>ê³µì œì•¡</th><th>ì‹¤ì§€ê¸‰ì•¡</th><th class="admin-el">ì…ê¸ˆ ê³„ì¢Œ</th></tr></thead>
          <tbody id="settle-tbody"></tbody></table>
        </div>
      </div>
    </div>

    <!-- MEMBERS -->
    <div class="page" id="page-members">
      <div class="page-header"><h2>ì¸ì ì‚¬í•­ ê´€ë¦¬</h2><p>ì¡°êµ ê°œì¸ ì •ë³´ ë° ê°œì¸ ì‹œê¸‰ ê´€ë¦¬ â€” ê´€ë¦¬ì ì „ìš©</p></div>
      <div class="admin-banner">ğŸ”’ ì´ í˜ì´ì§€ëŠ” ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤. ê°œì¸ì •ë³´(ì£¼ë¯¼ë²ˆí˜¸, ê³„ì¢Œ)ì™€ ì‹œê¸‰ ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</div>
      <div class="card">
        <div class="card-title">ì¡°êµ ëª©ë¡ <button class="btn btn-primary btn-sm" onclick="openAddMember()">+ ì¡°êµ ì¶”ê°€</button></div>
        <div class="search-bar"><input type="text" id="m-search" placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸, ê³„ì¢Œë²ˆí˜¸ ê²€ìƒ‰..." oninput="renderMembers()"></div>
        <div class="table-wrap">
          <table><thead><tr><th>#</th><th>ì´ë¦„</th><th>í•¸ë“œí°</th><th>ì£¼ë¯¼ë²ˆí˜¸</th><th>ê³„ì¢Œë²ˆí˜¸</th><th>ê°œì¸ ì‹œê¸‰</th><th>PIN</th><th>ì£¼ì†Œ</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody id="members-tbody"></tbody></table>
        </div>
      </div>
    </div>

    <!-- MYPAGE -->
    <div class="page" id="page-mypage">
      <div class="page-header"><h2>ğŸ‘¤ ë‚´ ì •ë³´</h2><p id="mypage-sub">ë³¸ì¸ ì‹œê¸‰ì„ ì§ì ‘ ë“±ë¡í•˜ì„¸ìš”</p></div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start;">
        <!-- ì‹œê¸‰ ì„¤ì • ì¹´ë“œ -->
        <div class="card">
          <div class="card-title">ğŸ’° ë‚´ ì‹œê¸‰ ì„¤ì •</div>
          <div style="margin-bottom:18px;">
            <div style="font-size:12px;color:var(--text3);margin-bottom:6px;">í˜„ì¬ ë“±ë¡ëœ ì‹œê¸‰</div>
            <div id="my-current-rate" style="font-size:32px;font-weight:900;font-family:&#39;Space Mono&#39;,monospace;color:var(--success);">-</div>
            <div style="font-size:11px;color:var(--text3);margin-top:4px;">ì› / ì‹œê°„</div>
          </div>
          <div class="divider"></div>
          <div class="form-group" style="margin-top:16px;margin-bottom:14px;">
            <label>ìƒˆ ì‹œê¸‰ ì…ë ¥ (ì›/ì‹œê°„)</label>
            <input type="number" id="my-rate-input" placeholder="ì˜ˆ: 12000" min="0" step="100" style="font-size:18px;font-family:&#39;Space Mono&#39;,monospace;padding:12px 16px;">
            <p style="font-size:11px;color:var(--text3);margin-top:6px;">
              í˜„ì¥ ì¶œê·¼ Â· ë§ˆë§ˆì½” í˜„ì¥ ì¶œê·¼ ê³„ì‚°ì— ìë™ ì ìš©ë©ë‹ˆë‹¤. (ì—°êµ¬ì‹¤ì€ ë§¤ë²ˆ ì§ì ‘ ì…ë ¥)
            </p>
          </div>
          <button class="btn btn-primary" style="width:100%;padding:12px;" onclick="saveMyRate()">
            ì €ì¥í•˜ê¸°
          </button>
          <p id="my-rate-msg" style="font-size:12px;text-align:center;margin-top:10px;min-height:18px;"></p>
        </div>

        <!-- ì•ˆë‚´ ì¹´ë“œ -->
        <div class="card">
          <div class="card-title">ğŸ“‹ ì‹œê¸‰ ì•ˆë‚´</div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;">
              <div style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;">ì ìš© í•­ëª©</div>
              <div style="font-size:13px;color:var(--text);display:flex;flex-direction:column;gap:4px;">
                <span>ğŸ« ì¡°êµ (í˜„ì¥ ì¶œê·¼)</span>
                <span style="color:var(--text3);text-decoration:line-through;">ğŸ”¬ ì—°êµ¬ì‹¤ ê·¼ë¬´ (ë§¤ë²ˆ ì§ì ‘ ì…ë ¥)</span>
                <span>ğŸ« ë§ˆë§ˆì½” í˜„ì¥ ì¶œê·¼</span>
              </div>
            </div>
            <div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:10px;padding:14px;font-size:12px;color:var(--warning);">
              âš ï¸ ì‹œê¸‰ì€ ì„œí›„T(ê´€ë¦¬ì)ê°€ ë³„ë„ë¡œ ì¬ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ìƒí•˜ê±°ë‚˜ ë‹¤ë¥¼ ê²½ìš° ë¬¸ì˜í•´ì£¼ì„¸ìš”.
            </div>
            <div style="background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.25);border-radius:10px;padding:14px;font-size:12px;color:var(--success);">
              âœ… ì‹œê¸‰ ì €ì¥ í›„ ëª¨ë“  ê³„ì‚°ê¸°ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- â•â•â•â•â•â•â•â• MAMAKO CALCULATOR â•â•â•â•â•â•â•â• -->
    <div class="page" id="page-mamako-calc">
      <div class="page-header">
        <h2>ğŸ§® ì •ì‚° ê³„ì‚°ê¸°</h2>
        <p>ë§ˆë§ˆì½” ì¸ê±´ë¹„ ê¸°ì¤€ìœ¼ë¡œ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤ (2026)</p>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start;">
        <!-- LEFT: INPUT -->
        <div>
          <!-- ì˜¨ë¼ì¸ ë§ˆë§ˆì½” -->
          <div class="mamako-section">
            <div class="mamako-section-title">
              <span style="font-size:18px;">ğŸ’»</span> ì˜¨ë¼ì¸ ë§ˆë§ˆì½”
            </div>

            <div style="margin-bottom:16px;">
              <div style="font-size:12px;color:var(--text2);margin-bottom:8px;font-weight:600;">â‘  í”¼ë“œë°± + ì°¸ì—¬</div>
              <div style="font-size:11px;color:var(--text3);margin-bottom:10px;">í”¼ë“œë°±: ê±´ë‹¹ 2,000ì› / ì°¸ì—¬: íšŸìˆ˜ Ã— 2,000ì›</div>
              <div class="form-row c2" style="margin-bottom:8px;">
                <div class="form-group">
                  <label>í”¼ë“œë°± ê±´ìˆ˜</label>
                  <div class="num-input-group"><input type="number" id="mm-feedback" value="0" min="0" oninput="calcMamako()"><span class="unit">ê±´ Ã— 2,000ì›</span></div>
                </div>
                <div class="form-group">
                  <label>ì°¸ì—¬ íšŸìˆ˜</label>
                  <div class="num-input-group"><input type="number" id="mm-attend" value="0" min="0" oninput="calcMamako()"><span class="unit">íšŒ Ã— 2,000ì›</span></div>
                </div>
              </div>
            </div>

            <div class="divider" style="margin:12px 0;"></div>

            <div>
              <div style="font-size:12px;color:var(--text2);margin-bottom:8px;font-weight:600;">â‘¡ ìˆ˜ì • / ê²Œì‹œ / ëˆ„ë½ë°±ì—… / í˜„í™©ì—…ë°ì´íŠ¸</div>
              <div style="font-size:11px;color:var(--text3);margin-bottom:10px;">ì‹œê¸‰ 12,000ì› Ã— ì†Œìš” ì‹œê°„</div>
              <div class="form-group">
                <label>ì†Œìš” ì‹œê°„ (ì‹œê°„)</label>
                <div class="num-input-group"><input type="number" id="mm-edit-hours" value="0" min="0" step="0.5" oninput="calcMamako()"><span class="unit">ì‹œê°„ Ã— 12,000ì›</span></div>
              </div>
            </div>
          </div>

          <!-- ì§ˆë‹µ -->
          <div class="mamako-section">
            <div class="mamako-section-title">
              <span style="font-size:18px;">â“</span> ì§ˆë‹µ
            </div>
            <div style="font-size:11px;color:var(--text3);margin-bottom:12px;">100ê°œ ë¯¸ë§Œ: 800ì›/ê±´ | 100ê°œ ì´ìƒ: 1,000ì›/ê±´</div>
            <div class="form-group">
              <label>ì§ˆë‹µ ê±´ìˆ˜</label>
              <div class="num-input-group">
                <input type="number" id="mm-qa" value="0" min="0" oninput="calcMamako()">
                <span class="unit" id="qa-unit-hint">ê±´</span>
              </div>
              <div style="font-size:11px;color:var(--text3);margin-top:6px;" id="qa-breakdown"></div>
            </div>
          </div>

          <!-- í˜„ì¥ -->
          <div class="mamako-section">
            <div class="mamako-section-title">
              <span style="font-size:18px;">ğŸ«</span> í˜„ì¥ ì¶œê·¼
            </div>
            <div style="font-size:11px;color:var(--text3);margin-bottom:12px;">ì¡°êµë³„ ê°œì¸ ì‹œê¸‰ Ã— ì¶œê·¼ ì‹œê°„</div>
            <div class="form-row c2">
              <div class="form-group">
                <label>ì¶œê·¼ ì‹œê°„</label>
                <div class="num-input-group"><input type="number" id="mm-field-hours" value="0" min="0" step="0.5" oninput="calcMamako()"><span class="unit">ì‹œê°„</span></div>
              </div>
              <div class="form-group">
                <label>ê°œì¸ ì‹œê¸‰ (ì›/h)</label>
                <input type="number" id="mm-field-rate" value="10000" min="0" oninput="calcMamako()">
                <div id="mm-field-rate-fixed" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:9px 12px;font-size:13px;font-family:&#39;Space Mono&#39;,monospace;color:var(--success);"></div>
              </div>
            </div>
            <div id="mm-member-select-wrap" style="margin-top:8px;">
              <label style="margin-bottom:6px;display:block;">ì¡°êµ ì„ íƒ ì‹œ ì‹œê¸‰ ìë™ ì…ë ¥</label>
              <select id="mm-member-select" onchange="onMamakoMemberChange()">
                <option value="">-- ì¡°êµ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>
              </select>
            </div>
          </div>

          <!-- ì—°êµ¬ì‹¤ -->
          <div class="mamako-section">
            <div class="mamako-section-title">
              <span style="font-size:18px;">ğŸ”¬</span> ì—°êµ¬ì‹¤
            </div>
            <div style="font-size:11px;color:var(--text3);margin-bottom:12px;">ê·¼ë¬´ ì‹œê°„ê³¼ ì‹œê¸‰ì„ ë§¤ë²ˆ ì§ì ‘ ì…ë ¥í•©ë‹ˆë‹¤</div>
            <div class="form-row c2">
              <div class="form-group">
                <label>ê·¼ë¬´ ì‹œê°„</label>
                <div class="num-input-group">
                  <input type="number" id="mm-lab-hours" value="0" min="0" step="0.5" oninput="calcMamako()">
                  <span class="unit">ì‹œê°„</span>
                </div>
              </div>
              <div class="form-group">
                <label>ì‹œê¸‰ (ì›/h)</label>
                <input type="number" id="mm-lab-rate" value="10000" min="0" oninput="calcMamako()">
              </div>
            </div>
            <div style="font-size:11px;color:var(--text3);margin-top:4px;" id="lab-rate-hint"></div>
          </div>

          <!-- ì •ì‚°ì— ì¶”ê°€ ë²„íŠ¼ -->
          <div style="display:flex;gap:10px;">
            <button class="btn btn-purple" style="flex:1;" onclick="openSaveMamakoModal()">ğŸ“‹ ì—…ë¬´ë‚´ì—­ì— ì¶”ê°€í•˜ê¸°</button>
            <button class="btn btn-secondary" onclick="resetMamako()">ì´ˆê¸°í™”</button>
          </div>
        </div>

        <!-- RIGHT: RESULT -->
        <div>
          <div class="card" style="margin-bottom:0;">
            <div class="card-title">ğŸ’° ê³„ì‚° ê²°ê³¼</div>

            <div class="mamako-result-box" style="margin-bottom:16px;">
              <div style="font-size:11px;color:var(--accent2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;">ì„¸ì „ í•©ê³„</div>
              <div class="big-result" id="mm-total-before">0 ì›</div>
            </div>

            <div style="margin-bottom:16px;">
              <div class="result-line">
                <span class="label">ğŸ’» ì˜¨ë¼ì¸ í”¼ë“œë°± + ì°¸ì—¬</span>
                <span class="val" id="r-feedback">0 ì›</span>
              </div>
              <div class="result-line">
                <span class="label">âœï¸ ìˆ˜ì •/ê²Œì‹œ/ëˆ„ë½ë°±ì—…/í˜„í™©</span>
                <span class="val" id="r-edit">0 ì›</span>
              </div>
              <div class="result-line">
                <span class="label">â“ ì§ˆë‹µ</span>
                <span class="val" id="r-qa">0 ì›</span>
              </div>
              <div class="result-line">
                <span class="label">ğŸ« í˜„ì¥ ì¶œê·¼</span>
                <span class="val" id="r-field">0 ì›</span>
              </div>
              <div class="result-line">
                <span class="label">ğŸ”¬ ì—°êµ¬ì‹¤</span>
                <span class="val" id="r-lab">0 ì›</span>
              </div>
            </div>

            <div class="divider"></div>

            <div style="background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:10px;padding:16px;margin-bottom:12px;">
              <div class="result-line" style="padding:4px 0;">
                <span style="font-size:13px;color:var(--text2);">ì„¸ì „ í•©ê³„</span>
                <span style="font-family:&#39;Space Mono&#39;,monospace;font-weight:700;" id="r-before2">0 ì›</span>
              </div>
              <div class="result-line" style="padding:4px 0;">
                <span style="font-size:13px;color:var(--text2);">ì‚¬ì—…ì†Œë“ì„¸ (<span id="mm-tax-pct">3.3</span>%)</span>
                <span style="font-family:&#39;Space Mono&#39;,monospace;color:var(--warning);" id="r-tax">-0 ì›</span>
              </div>
              <div class="result-line" style="border-bottom:none;padding:4px 0;">
                <span style="font-size:14px;font-weight:700;color:var(--success);">ì‹¤ì§€ê¸‰ì•¡ (ì„¸í›„)</span>
                <span style="font-family:&#39;Space Mono&#39;,monospace;font-size:18px;font-weight:900;color:var(--success);" id="r-net">0 ì›</span>
              </div>
            </div>

            <!-- í•­ëª©ë³„ ì‹œê°„ ìš”ì•½ -->
            <div style="font-size:11px;color:var(--text3);background:var(--bg);border-radius:8px;padding:12px;">
              <div style="font-weight:700;color:var(--text2);margin-bottom:8px;">ğŸ“‹ ì…ë ¥ ë‚´ì—­ ìš”ì•½</div>
              <div id="mm-summary-lines" style="display:flex;flex-direction:column;gap:4px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â• MEMBER ONE-PAGE â•â•â•â•â•â•â•â• -->
    <div class="page" id="page-member-home">
      <div class="page-header" style="margin-bottom:20px;">
        <h2 id="member-home-title">ì•ˆë…•í•˜ì„¸ìš” ğŸ‘‹</h2>
        <p id="member-home-sub">ì •ì‚° ë‚´ìš©ì„ ê¸°ë¡í•˜ê³  í™•ì¸í•˜ì„¸ìš”</p>
      </div>

      <!-- â”€â”€ ì„¹ì…˜ 1: ì •ì‚° ê³„ì‚°ê¸° â”€â”€ -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-title" style="font-size:16px;">ğŸ§® ì •ì‚° ê³„ì‚°ê¸°</div>

        <!-- ë‚ ì§œ + ì—…ë¬´ìœ í˜• -->
        <div class="form-row c2" style="margin-bottom:14px;">
          <div class="form-group">
            <label>ë‚ ì§œ</label>
            <input type="date" id="mc-date">
          </div>
          <div class="form-group">
            <label>ì—…ë¬´ ìœ í˜•</label>
            <select id="mc-type" onchange="mcTypeChange()">
              <option value="">â”€â”€ ì„ íƒ â”€â”€</option>
              <option value="mamako-online">ğŸ’» ì˜¨ë¼ì¸ ë§ˆë§ˆì½”</option>
              <option value="mamako-qa">â“ ì§ˆë‹µ</option>
              <option value="ta">ğŸ« í˜„ì¥ ì¶œê·¼</option>
              <option value="lab">ğŸ”¬ ì—°êµ¬ì‹¤</option>
            </select>
          </div>
        </div>

        <!-- ë™ì  ì…ë ¥ ì˜ì—­ -->
        <div id="mc-inputs" style="margin-bottom:14px;"></div>

        <!-- ê³„ì‚° ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
        <div id="mc-result-box" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="font-size:12px;color:var(--text2);">ì„¸ì „ ê¸ˆì•¡</span>
            <span id="mc-result-before" style="font-family:&#39;Space Mono&#39;,monospace;font-size:20px;font-weight:900;color:var(--accent2);">0 ì›</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="font-size:12px;color:var(--text2);">ì„¸ê¸ˆ (<span id="mc-tax-pct">3.3</span>%)</span>
            <span id="mc-result-tax" style="font-family:&#39;Space Mono&#39;,monospace;font-size:13px;color:var(--warning);">-0 ì›</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border);padding-top:10px;">
            <span style="font-size:13px;font-weight:700;color:var(--success);">ì‹¤ì§€ê¸‰ì•¡ (ì„¸í›„)</span>
            <span id="mc-result-net" style="font-family:&#39;Space Mono&#39;,monospace;font-size:18px;font-weight:900;color:var(--success);">0 ì›</span>
          </div>
        </div>

        <button class="btn btn-primary" style="width:100%;padding:12px;font-size:14px;" onclick="mcSave()">
          âœ… ì—…ë¬´ ê¸°ë¡í•˜ê¸°
        </button>
        <p id="mc-save-msg" style="font-size:12px;color:var(--success);text-align:center;margin-top:8px;min-height:18px;"></p>
      </div>

      <!-- â”€â”€ ì„¹ì…˜ 2: ì›”ë³„ ì •ì‚° í˜„í™© â”€â”€ -->
      <div class="card">
        <div class="card-title" style="font-size:16px;">
          ğŸ’° ì›”ë³„ ì •ì‚° í˜„í™©
          <div style="display:flex;gap:8px;">
            <select id="mc-sy" onchange="renderMemberHome()" style="font-size:12px;padding:5px 8px;"></select>
            <select id="mc-sm" onchange="renderMemberHome()" style="font-size:12px;padding:5px 8px;"></select>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
          <div class="stat-card accent" style="padding:14px;"><div class="stat-label">ì„¸ì „</div><div id="mc-st-before" style="font-size:20px;font-weight:700;font-family:&#39;Space Mono&#39;,monospace;color:var(--accent);">0</div><div class="stat-sub">ì›</div></div>
          <div class="stat-card" style="padding:14px;"><div class="stat-label">ê³µì œ(3.3%)</div><div id="mc-st-tax" style="font-size:20px;font-weight:700;font-family:&#39;Space Mono&#39;,monospace;color:var(--warning);">0</div><div class="stat-sub">ì›</div></div>
          <div class="stat-card success" style="padding:14px;"><div class="stat-label">ì‹¤ì§€ê¸‰ì•¡</div><div id="mc-st-net" style="font-size:20px;font-weight:700;font-family:&#39;Space Mono&#39;,monospace;color:var(--success);">0</div><div class="stat-sub">ì›</div></div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>ë‚ ì§œ</th><th>ìœ í˜•</th><th>ë‚´ìš©</th><th>ì‹œê°„</th><th>ê¸ˆì•¡(ì„¸ì „)</th><th>ê´€ë¦¬</th></tr></thead>
            <tbody id="mc-settle-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /app -->

<!-- MEMBER EDIT MODAL -->
<div class="modal-overlay" id="modal-mc-edit">
  <div class="modal">
    <div class="modal-header"><h3>âœï¸ ê¸°ë¡ ìˆ˜ì •</h3><button class="modal-close" onclick="closeModal(&#39;modal-mc-edit&#39;)">âœ•</button></div>
    <div class="modal-body">
      <div class="form-row c2" style="margin-bottom:14px;">
        <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="mce-date"></div>
        <div class="form-group"><label>ì—…ë¬´ ìœ í˜•</label>
          <select id="mce-type" onchange="mceTypeChange()">
            <option value="mamako-online">ğŸ’» ì˜¨ë¼ì¸ ë§ˆë§ˆì½”</option>
            <option value="mamako-qa">â“ ì§ˆë‹µ</option>
            <option value="ta">ğŸ« í˜„ì¥ ì¶œê·¼</option>
            <option value="lab">ğŸ”¬ ì—°êµ¬ì‹¤</option>
          </select>
        </div>
      </div>
      <div id="mce-inputs" style="margin-bottom:14px;"></div>
      <div class="form-group">
        <label>ê¸ˆì•¡(ì„¸ì „) â€” ìë™ê³„ì‚°</label>
        <input type="number" id="mce-amount" readonly="" style="color:var(--accent2);font-family:&#39;Space Mono&#39;,monospace;font-size:18px;padding:10px 14px;">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal(&#39;modal-mc-edit&#39;)">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="mcEditSave()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- WORK MODAL -->
<div class="modal-overlay" id="modal-work">
  <div class="modal">
    <div class="modal-header"><h3 id="mw-title">ì—…ë¬´ ë³´ê³  ì¶”ê°€</h3><button class="modal-close" onclick="closeModal(&#39;modal-work&#39;)">âœ•</button></div>
    <div class="modal-body" style="display:flex;flex-direction:column;">
      <div class="form-row c2" style="order:0;">
        <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="mw-date"></div>
        <div class="form-group"><label>ì´ë¦„</label><select id="mw-name" onchange="onNameChange()"><option value="">-- ì„ íƒ --</option></select><div id="mw-name-display" style="display:none;background:var(--bg);border:1px solid var(--border);color:var(--accent);padding:9px 12px;border-radius:8px;font-size:13px;font-weight:700;"></div></div>
      </div>
      <div class="form-group" style="margin-bottom:14px;order:1;">
        <label>ì—…ë¬´ ìœ í˜•</label>
        <select id="mw-type" onchange="onWorkTypeChange()">
          <option value="mamako-online">ë§ˆë§ˆì½”-ì˜¨ë¼ì¸</option>
          <option value="ta">í˜„ì¥ì¡°êµ</option>
          <option value="mamako-qa">ì§ˆì˜ì‘ë‹µ</option>
          <option value="lab">ì—°êµ¬ì‹¤</option>
        </select>
      </div>
      <!-- ë™ì  ì…ë ¥ ì˜ì—­ -->
      <div id="mw-dynamic" style="order:2;"></div>
      <div class="form-row c2" style="margin-top:14px;order:3;">
        <div class="form-group"><label>ê¸ˆì•¡(ì„¸ì „) â€” ìë™ê³„ì‚°</label><input type="number" id="mw-amount" readonly="" style="color:var(--accent);"></div>
        <div class="form-group"><label>ë¹„ê³ </label><input type="text" id="mw-note" placeholder="ë©”ëª¨"></div>
      </div>
      <div class="form-group" id="mw-detail-wrap" style="order:4;"><label id="mw-detail-label">ìƒì„¸ ì—…ë¬´ ë‚´ìš©</label><textarea id="mw-detail" placeholder="ì—…ë¬´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal(&#39;modal-work&#39;)">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveWork()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- SAVE MAMAKO TO WORK MODAL -->
<div class="modal-overlay" id="modal-save-mamako">
  <div class="modal">
    <div class="modal-header"><h3>ğŸ“‹ ë§ˆë§ˆì½” ê³„ì‚° ê²°ê³¼ë¥¼ ì—…ë¬´ë‚´ì—­ì— ì¶”ê°€</h3><button class="modal-close" onclick="closeModal(&#39;modal-save-mamako&#39;)">âœ•</button></div>
    <div class="modal-body">
      <div class="form-row c2">
        <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="smm-date"></div>
        <div class="form-group"><label>ì´ë¦„</label><select id="smm-name"><option value="">-- ì„ íƒ --</option></select><div id="smm-name-display" style="display:none;background:var(--bg);border:1px solid var(--border);color:var(--accent);padding:9px 12px;border-radius:8px;font-size:13px;font-weight:700;"></div></div>
      </div>
      <div id="smm-preview" style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;margin-top:4px;font-size:13px;"></div>
      <div class="form-group" style="margin-top:14px;"><label>ë¹„ê³ </label><input type="text" id="smm-note" placeholder="ë©”ëª¨"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal(&#39;modal-save-mamako&#39;)">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveMamakoToWork()">ì—…ë¬´ë‚´ì—­ì— ì¶”ê°€</button>
    </div>
  </div>
</div>

<!-- MEMBER MODAL -->
<div class="modal-overlay" id="modal-member">
  <div class="modal">
    <div class="modal-header"><h3 id="mm-title">ì¡°êµ ì¶”ê°€</h3><button class="modal-close" onclick="closeModal(&#39;modal-member&#39;)">âœ•</button></div>
    <div class="modal-body">
      <div class="form-row c2">
        <div class="form-group"><label>ì´ë¦„ *</label><input type="text" id="mm-name" placeholder="í™ê¸¸ë™"></div>
        <div class="form-group"><label>í•¸ë“œí°</label><input type="text" id="mm-phone" placeholder="010-0000-0000"></div>
      </div>
      <div class="form-row c2">
        <div class="form-group"><label>ì£¼ë¯¼ë²ˆí˜¸</label><input type="text" id="mm-ssn" placeholder="000000-0000000"></div>
        <div class="form-group admin-rate-field"><label>ê°œì¸ ì‹œê¸‰ (ì›/ì‹œê°„) â˜…</label><input type="number" id="mm-rate" placeholder="ì˜ˆ: 10000" min="0"></div>
      </div>
      <div class="form-group admin-rate-field" style="margin-bottom:14px;">
        <label>PIN ë²ˆí˜¸ <span style="font-size:10px;color:var(--text3);font-weight:400;">(ì¡°êµ ë¡œê·¸ì¸ìš© Â· ìˆ«ì 4~8ìë¦¬)</span></label>
        <input type="text" id="mm-pin" placeholder="ì˜ˆ: 1234" maxlength="8" inputmode="numeric" style="font-family:&#39;Space Mono&#39;,monospace;letter-spacing:3px;">
        <p style="font-size:11px;color:var(--text3);margin-top:4px;">ì„¤ì • í›„ ì¡°êµì—ê²Œ ì§ì ‘ ì „ë‹¬í•´ì£¼ì„¸ìš”.</p>
      </div>
      <div class="form-group" style="margin-bottom:14px;"><label>ê³„ì¢Œë²ˆí˜¸</label><input type="text" id="mm-account" placeholder="ì€í–‰ëª… ê³„ì¢Œë²ˆí˜¸"></div>
      <div class="form-group"><label>ì£¼ì†Œ</label><textarea id="mm-address" style="min-height:60px;"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal(&#39;modal-member&#39;)">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveMember()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="modal-settings">
  <div class="modal">
    <div class="modal-header"><h3>âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h3><button class="modal-close" onclick="closeModal(&#39;modal-settings&#39;)">âœ•</button></div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom:20px;">
        <label>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</label>
        <input type="password" id="sp-1" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" style="margin-bottom:8px;">
        <input type="password" id="sp-2" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
        <p id="sp-msg" style="font-size:12px;margin-top:6px;min-height:18px;"></p>
      </div>
      <div class="divider"></div>
      <div class="form-group">
        <label>ì‚¬ì—…ì†Œë“ì„¸ìœ¨ (%)</label>
        <input type="number" id="s-tax" step="0.1" min="0" max="100">
        <p style="font-size:11px;color:var(--text3);margin-top:4px;">ë³€ê²½ ì‹œ ëª¨ë“  ì •ì‚°ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤ (ê¸°ë³¸ê°’ 3.3%)</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal(&#39;modal-settings&#39;)">ë‹«ê¸°</button>
      <button class="btn btn-primary" onclick="saveSettings()">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ DATA â”€â”€â”€
let members=[], workReports=[];
let adminPw='ghkddudgus', taxRate=0.033;
let currentUser=null;
let editWorkIdx=null, editMemberIdx=null;

const TYPE_LABEL={
  'mamako-online':'ë§ˆë§ˆì½”-ì˜¨ë¼ì¸', ta:'í˜„ì¥ì¡°êµ',
  'mamako-qa':'ì§ˆì˜ì‘ë‹µ', lab:'ì—°êµ¬ì‹¤',
  'mamako-edit':'ë§ˆë§ˆì½”-ì˜¨ë¼ì¸','mamako-field':'í˜„ì¥ì¡°êµ'
};

const INIT_MEMBERS=[
  {name:'ê¹€ì„±ë¯¼', phone:'010-2827-5824',ssn:'020727-4095020',account:'ë†í˜‘ 3022694339141',address:'ë¶€ì‚°ê´‘ì—­ì‹œ í•´ìš´ëŒ€êµ¬ í•´ìš´ëŒ€ë¡œ 284, 103ë™ 1402í˜¸',rate:10000},
  {name:'ê¹€ì˜ˆì§„', phone:'010-3307-6681',ssn:'001006-4674611',account:'KBêµ­ë¯¼ì€í–‰ 81360201182257',address:'ëŒ€êµ¬ê´‘ì—­ì‹œ ë‹¬ì„œêµ¬ ì¡°ì•”ë¡œ6ê¸¸ 20',rate:10000},
  {name:'ê¹€ì±„ë ¹', phone:'010-8301-6774',ssn:'051113-4158610',account:'ì‹ í•œ 110-339-494318',address:'ê²½ëª…ëŒ€ë¡œ 1142ë²ˆê¸¸ 7 2ë™602í˜¸',rate:10000},
  {name:'ë‚¨ìœ¤ì§€', phone:'010-2478-2943',ssn:'030530-4121218',account:'ë¶€ì‚°ì€í–‰ 112-2212-9933-08 ë‚¨ìœ¤ì§€',address:'ì„œìš¸ì‹œ ì¤‘êµ¬ ë™í˜¸ë¡œ25ê°€ê¸¸ 52, B01í˜¸',rate:10000},
  {name:'ë°•ìŠ¹í˜„', phone:'010-2801-5033',ssn:'050119-4768315',account:'ì¹´ì¹´ì˜¤ë±…í¬ 3333259848576',address:'ì„œìš¸íŠ¹ë³„ì‹œ ë™ëŒ€ë¬¸êµ¬ ì´ë¬¸ë¡œ 156 504í˜¸',rate:10000},
  {name:'ë°•ì€ì„±', phone:'010-5288-8604',ssn:'061106-4696910',account:'êµ­ë¯¼ì€í–‰ 962701-01-483334',address:'ëŒ€êµ¬ê´‘ì—­ì‹œ ë¶êµ¬ êµ¬ì•”ë¡œ 65ê¸¸ 9, 304ë™ 701í˜¸',rate:10000},
  {name:'ì†¡ì§€ì•ˆ', phone:'010-3498-8176',ssn:'000727-4692713',account:'ìš°ë¦¬ì€í–‰ 1002955268171',address:'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ìˆ˜ì„±ë¡œ 71 109ë™ 1507í˜¸',rate:10000},
  {name:'ì˜¤ìˆ˜ì§„', phone:'010-7370-6730',ssn:'050820-4070216',account:'í† ìŠ¤ë±…í¬ 1001-6541-4870',address:'ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì ì‹¤ë™ ë¦¬ì„¼ì¸  ì•„íŒŒíŠ¸ 232-2403í˜¸',rate:10000},
  {name:'ì´ì˜ˆìŠ¹', phone:'010-9237-3259',ssn:'060418-4174410',account:'ì‹ í•œ 110-380-485367',address:'ê²½ê¸°ë„ ì˜ì •ë¶€ì‹œ ì¥ê³¡ë¡œ 532 104ë™ 1902í˜¸',rate:10000},
  {name:'ì „ìˆ˜ì§„', phone:'010-7181-8420',ssn:'041210-4213919',account:'ì‹ í•œ 110510615340',address:'ê²½ê¸°ë„ ë‚¨ì–‘ì£¼ì‹œ ë³„ë‚´ë™ 999',rate:10000},
  {name:'ì •í•˜ì—°', phone:'010-5342-5522',ssn:'051116-4698633',account:'ì¹´ì¹´ì˜¤ë±…í¬ 3333268670091',address:'ëŒ€êµ¬ê´‘ì—­ì‹œ ë¶êµ¬ ë™ì²œë¡œ 24ê¸¸ 12 202ë™ 1902í˜¸',rate:10000},
  {name:'ì¡°í¬ì›', phone:'010-5117-7850',ssn:'040704-3056229',account:'ì‹ í•œì€í–‰ 110503940000',address:'ì„œì´ˆêµ¬ ì ì›ë™ ì ì›í›¼ë¯¸ë¦¬ì•„íŒŒíŠ¸ 2ë™ 901í˜¸',rate:10000},
  {name:'ìµœë¦°',   phone:'010-5429-0706',ssn:'020706-4050119',account:'êµ­ë¯¼ 591902-01-408710',address:'ì¸ì²œê´‘ì—­ì‹œ ë¶€í‰êµ¬ ë¶€ê°œë™ ê¸¸ì£¼ë‚¨ë¡œ 144 307ë™ 1502í˜¸',rate:10000},
  {name:'í—ˆì‹œì€', phone:'010-3665-5133',ssn:'990804-2684719',account:'ì¹´ì¹´ì˜¤ë±…í¬ 3333-25-1698256',address:'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ìˆ˜ì„±ë¡œ 51ê¸¸ 59-9',rate:10000},
  {name:'í™ì¤€ìš©', phone:'010-9153-0378',ssn:'980216-1748443',account:'í•˜ë‚˜ì€í–‰ 39191109690107',address:'ê²½ìƒë¶ë„ ê²½ì‚°ì‹œ íœíƒ€íì¦ˆ1ë¡œ 84, 203ë™ 1702í˜¸',rate:10000},
  {name:'ì†ìœ ë¹ˆ', phone:'',ssn:'',account:'',address:'',rate:10000},
  {name:'í™©ì˜í˜„', phone:'010-6792-4892',ssn:'010311-4182416',account:'3333120788633 ì¹´ì¹´ì˜¤ë±…í¬',address:'ê²½ê¸°ë„ ë¶€ì²œì‹œ ì„±ì£¼ë¡œ 100-10 ì†¡ë‚´ ì´í¸í•œì„¸ìƒ 105ë™ 903í˜¸',rate:10000},
  {name:'ì•ˆíƒœì˜', phone:'010-5948-8695',ssn:'981203-2235021',account:'ë†í˜‘ 352-1938-4272-13',address:'ê²½ê¸°ë„ í™”ì„±ì‹œ ë´‰ë‹µì ìƒ˜ë§ˆì„ ê¸¸ 24 í•œì‹ ì•„íŒŒíŠ¸ 103ë™ 1908í˜¸',rate:10000},
  {name:'í•˜ë‹¤ì—°', phone:'010-6398-9537',ssn:'021119-4164624',account:'KBêµ­ë¯¼ 60370204105885',address:'ê²½ê¸°ë„ í™”ì„±ì‹œ ë´‰ë‹´ì ì™€ìš°ë¡œ73ë²ˆê¸¸ 22 105ë™ 304í˜¸',rate:10000},
  {name:'ë°•ì¤€í˜•', phone:'010-7760-3086',ssn:'060614-3162613',account:'ì¹´ì¹´ì˜¤ë±…í¬ 7777018626605',address:'ìˆ˜ì›ì‹œ ì˜í†µêµ¬ ë„ì²­ë¡œ 65 íìŠ¤í…Œì´íŠ¸ 5409ë™ 1204í˜¸',rate:10000},
  {name:'ë°•ì„œì—°', phone:'010-7229-2174',ssn:'071031-4047127',account:'ì¹´ì¹´ì˜¤ë±…í¬ 3333355652741',address:'ì„œìš¸ì‹œ ë§ˆí¬êµ¬ ë§Œë¦¬ì¬ì˜›ê¸¸ 25 ê°€ë™ 106í˜¸',rate:10000},
  {name:'ë°•ì„±í˜œ', phone:'010-5100-7565',ssn:'071211-4185428',account:'í† ìŠ¤ë±…í¬ 1908-3375-1131',address:'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ë„ê³¡ë¡œ 43ê¸¸ 21',rate:10000},
  {name:'ì¡°ì˜ì§€', phone:'010-3109-2773',ssn:'041006-4250831',account:'KBêµ­ë¯¼ì€í–‰ 84150104177096',address:'ì„œìš¸ì‹œ ë„ë´‰êµ¬ ë…¸í•´ë¡œ 70ê¸¸ 19',rate:10000},
  {name:'ì´ìœ ì§„', phone:'010-9887-3128',ssn:'060927-4057230',account:'ì¹´ì¹´ì˜¤ë±…í¬ 3333355935628',address:'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì„ ë¦‰ë¡œ 72ê¸¸ 15, 303í˜¸',rate:10000},
  {name:'ê¹€ë¯¼ìˆ˜', phone:'010-5690-1018',ssn:'010222-3253725',account:'í† ìŠ¤ë±…í¬ 1000-2051-2153',address:'ì„œìš¸íŠ¹ë³„ì‹œ ê´‘ì§„êµ¬ ì•„ì°¨ì‚°ë¡œ 410, Bë™ 1323í˜¸',rate:10000},
  {name:'ì†¡ì£¼ì—½', phone:'010-4082-0753',ssn:'061004-3025311',account:'êµ­ë¯¼ 00990204340547',address:'ì„œìš¸íŠ¹ë³„ì‹œ ì–‘ì²œêµ¬ ëª©ë™ì¤‘ì•™ë¶ë¡œ8ê¸¸ 71 104ë™ 601í˜¸',rate:10000},
  {name:'ê³ ìš°í˜', phone:'010-2753-7602',ssn:'060926-3192226',account:'ë†í˜‘ 3021487592701',address:'ê²½ê¸°ë„ í‰íƒì‹œ ì†¡íƒ„ë¡œ 170 í‰íƒë¡¯ë°ìºìŠ¬ 111ë™ 2004í˜¸',rate:10000},
  {name:'ìœ¤ì›ì¤€', phone:'010-2939-5978',ssn:'060319-3702916',account:'êµ­ë¯¼ 131602-00-034828',address:'ê²½ê¸°ë„ ìš©ì¸ì‹œ ê¸°í¥êµ¬ 623-1',rate:10000},
  {name:'ì°¨ë¦¬í˜„', phone:'010-2699-0810',ssn:'050810-4074413',account:'110615867109 ì‹ í•œ',address:'ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ê³ ë¬´ë˜ë¡œ35 109-1104',rate:10000},
  {name:'í•œì±„ì›', phone:'010-3816-8385',ssn:'050409-4025213',account:'í•˜ë‚˜ì€í–‰ 77291032199007',address:'ì„œìš¸íŠ¹ë³„ì‹œ ì–‘ì²œêµ¬ ì˜¤ëª©ë¡œ 300, ëª©ë™ í•˜ì´í˜ë¦¬ì˜¨2ì°¨ 206ë™ 3604í˜¸',rate:10000},
  {name:'ë°•ìƒìš±', phone:'010-7270-8023',ssn:'020122-3212818',account:'1000-1035-9225 í† ìŠ¤ë±…í¬',address:'ì„œìš¸íŠ¹ë³„ì‹œ ë…¸ì›êµ¬ ë™ì¼ë¡œ216ê¸¸ 47 502ë™ 501í˜¸',rate:10000},
  {name:'ì„ê°€ì¸', phone:'010-8384-2161',ssn:'070407-4249711',account:'êµ­ë¯¼ 24080204382869',address:'ê²½ê¸°ë„ ì˜¤ì‚°ì‹œ ì˜¤ì‚°ì²œë¡œ 2ì¸µ',rate:10000},
  {name:'ê°•ë¯¼ì§€', phone:'010-5966-6138',ssn:'071104-4166115',account:'ë†ì¶•í˜‘ 356-1286-9732-63',address:'ê²½ê¸°ë„ ìˆ˜ì›ì‹œ ì˜í†µêµ¬ íƒœì¥ë¡œ36ë²ˆê¸¸ 36',rate:10000},
  {name:'ê¹€ë¯¼í˜•', phone:'010-4034-9535',ssn:'020823-3054418',account:'110-473-201006 (ì‹ í•œ/ê¹€ë¯¼í˜•)',address:'ì„œìš¸ì‹œ ê°•ì„œêµ¬ í™”ê³¡ë¡œ63ê¸¸75 10ë™ 502í˜¸',rate:10000},
  {name:'í™©ì„œì§„', phone:'010-2569-4105',ssn:'030107-3897315',account:'í† ìŠ¤ë±…í¬ 1000-0791-9695',address:'ê²½ë‚¨ í•¨ì•ˆêµ° ì¹ ì›ì ì‚¼í˜¸ê¸¸ 181',rate:10000},
  {name:'ê°•ì„œí˜„', phone:'010-9000-4663',ssn:'070105-4037129',account:'í•˜ë‚˜ì€í–‰ 26791058902107',address:'ì„œìš¸íŠ¹ë³„ì‹œ ì„œëŒ€ë¬¸êµ¬ í†µì¼ë¡œ 34ê¸¸ 46 (101ë™ 1401í˜¸)',rate:10000},
  {name:'ê¹€í˜œêµ', phone:'010-6542-3620',ssn:'060328-4187491',account:'êµ­ë¯¼ 04680204273996',address:'ì„œìš¸ì‹œ ê´€ì•…êµ¬ ì„±í˜„ë¡œ80 ê´€ì•…ë“œë¦¼íƒ€ìš´ 107ë™ 1401í˜¸',rate:10000},
  {name:'ê¹€ë¯¼ê±´', phone:'010-4781-2005',ssn:'050716-3057113',account:'ì¹´ì¹´ì˜¤ë±…í¬ 3333261640097',address:'ê²½ê¸°ë„ ì•ˆì–‘ì‹œ ë§Œì•ˆêµ¬ ì¶©í›ˆë¡œ 51 ì„ìˆ˜ì•„ì´íŒŒí¬ 108ë™ 1502í˜¸',rate:10000},
  {name:'ì „ë¯¼ì„ ', phone:'',ssn:'',account:'',address:'',rate:10000},
  {name:'ë‚˜ì˜ë¡', phone:'',ssn:'',account:'',address:'',rate:10000},
  {name:'ì •ì€ì¬', phone:'',ssn:'',account:'',address:'',rate:10000},
  {name:'ê¹€ë¯¼ì¤€', phone:'010-3355-3754',ssn:'011025-3164522',account:'IBKê¸°ì—…ì€í–‰ 33908291601017',address:'ì„œìš¸ì‹œ ì„±ë¶êµ¬ ì •ë¦‰íìŠ¤í…Œì´íŠ¸1ì°¨ 201ë™ 102í˜¸',rate:10000},
];



// â”€â”€â”€ MEMBER ONE-PAGE â”€â”€â”€

const TYPE_LABEL_MC = {
  'mamako-online':'ì˜¨ë¼ì¸ ë§ˆë§ˆì½”',
  'mamako-qa':'ì§ˆì˜ì‘ë‹µ',
  'ta':'í˜„ì¥ ì¶œê·¼',
  'lab':'ì—°êµ¬ì‹¤',
};

const RATE_OPTIONS = [10000,11000,12000,13000,14000,15000,16000,17000,18000,19000,20000];

function mcRateDropdown(id, defaultVal){
  const val = defaultVal||10000;
  return `<select id="${id}" onchange="mcCalc()" style="font-family:'Space Mono',monospace;">
    ${RATE_OPTIONS.map(r=>`<option value="${r}" ${r===val?'selected':''}>${r.toLocaleString('ko-KR')}ì›/h</option>`).join('')}
  </select>`;
}

function mcTypeChange(){
  const type=document.getElementById('mc-type').value;
  const me=members.find(x=>x.name===currentUser.name);
  const myRate=me?me.rate||10000:10000;
  let html='';

  if(type==='mamako-online'){
    html=`<div class="form-row c2">
      <div class="form-group"><label>í”¼ë“œë°± ê±´ìˆ˜</label>
        <input type="number" id="mc-fb" value="0" min="0" oninput="mcCalc()" style="font-family:'Space Mono',monospace;">
        <div style="font-size:11px;color:var(--text3);margin-top:4px;">ê±´ Ã— 2,000ì›</div>
      </div>
      <div class="form-group"><label>ì°¸ì—¬ íšŸìˆ˜</label>
        <input type="number" id="mc-att" value="0" min="0" oninput="mcCalc()" style="font-family:'Space Mono',monospace;">
        <div style="font-size:11px;color:var(--text3);margin-top:4px;">íšŒ Ã— 2,000ì›</div>
      </div>
    </div>
    <div style="margin-top:10px;">
      <div style="font-size:12px;color:var(--text2);font-weight:600;margin-bottom:6px;">ìˆ˜ì •/ê²Œì‹œ/ëˆ„ë½/í˜„í™©</div>
      <div class="form-row c2">
        <div class="form-group"><label>ì†Œìš” ì‹œê°„</label>
          <input type="number" id="mc-edit" value="0" min="0" step="0.5" oninput="mcCalc()" style="font-family:'Space Mono',monospace;">
          <div style="font-size:11px;color:var(--text3);margin-top:4px;">ì‹œê°„ Ã— 12,000ì›</div>
        </div>
        <div></div>
      </div>
    </div>`;

  } else if(type==='mamako-qa'){
    html=`<div class="form-group">
      <label>ì§ˆë‹µ ê±´ìˆ˜</label>
      <input type="number" id="mc-qa" value="0" min="0" oninput="mcCalc()" style="font-family:'Space Mono',monospace;font-size:18px;padding:10px 14px;">
      <div style="font-size:11px;color:var(--text3);margin-top:6px;" id="mc-qa-hint">100ê°œ ë¯¸ë§Œ: 800ì›/ê±´ | 100ê°œ ì´ìƒ: 1,000ì›/ê±´</div>
    </div>`;

  } else if(type==='ta'){
    html=`<div class="form-row c2">
      <div class="form-group"><label>ì¶œê·¼ ì‹œê°„</label>
        <input type="number" id="mc-hours" value="0" min="0" step="0.5" oninput="mcCalc()" style="font-family:'Space Mono',monospace;font-size:18px;padding:10px 14px;">
      </div>
      <div class="form-group"><label>ì‹œê¸‰</label>
        ${mcRateDropdown('mc-rate', 10000)}
      </div>
    </div>`;

  } else if(type==='lab'){
    html=`<div class="form-row c2">
      <div class="form-group"><label>ê·¼ë¬´ ì‹œê°„</label>
        <input type="number" id="mc-hours" value="0" min="0" step="0.5" oninput="mcCalc()" style="font-family:'Space Mono',monospace;font-size:18px;padding:10px 14px;">
      </div>
      <div class="form-group"><label>ì‹œê¸‰</label>
        ${mcRateDropdown('mc-rate', 10000)}
      </div>
    </div>
    <div class="form-group" style="margin-top:10px;">
      <label>ì–´ë–¤ ì—…ë¬´ë¥¼ í–ˆë‚˜ìš”? <span style="color:var(--danger);font-weight:400;">(í•„ìˆ˜)</span></label>
      <input type="text" id="mc-detail" placeholder="ì˜ˆ) ë…¼ë¬¸ ìë£Œ ì •ë¦¬, ì„¤ë¬¸ ì…ë ¥, ë²ˆì—­ ë“±" style="border-color:var(--accent);">
    </div>`;
  }

  document.getElementById('mc-inputs').innerHTML=html;
  document.getElementById('mc-result-box').style.display='none';
  document.getElementById('mc-save-msg').textContent='';
  mcCalc();
}

function mcCalc(){
  const type=document.getElementById('mc-type').value;
  if(!type){document.getElementById('mc-result-box').style.display='none';return;}
  let total=0;

  if(type==='mamako-online'){
    const fb=parseInt(document.getElementById('mc-fb')?.value)||0;
    const att=parseInt(document.getElementById('mc-att')?.value)||0;
    const editH=parseFloat(document.getElementById('mc-edit')?.value)||0;
    total=(fb+att)*2000+Math.floor(editH*12000);
  } else if(type==='mamako-qa'){
    const qa=parseInt(document.getElementById('mc-qa')?.value)||0;
    total=calcQA(qa);
    const hint=document.getElementById('mc-qa-hint');
    if(hint){
      if(qa===0) hint.textContent='100ê°œ ë¯¸ë§Œ: 800ì›/ê±´ | 100ê°œ ì´ìƒ: 1,000ì›/ê±´';
      else hint.textContent=`${qa}ê±´ Ã— ${qa<100?'800':'1,000'}ì› = ${fmt(total)}ì›`;

    }
  } else if(type==='ta'||type==='lab'){
    const h=parseFloat(document.getElementById('mc-hours')?.value)||0;
    const r=parseInt(document.getElementById('mc-rate')?.value)||10000;
    total=Math.floor(h*r);
  }

  const tax=Math.floor(total*taxRate);
  const net=total-tax;
  const box=document.getElementById('mc-result-box');
  box.style.display=total>0?'':'none';
  document.getElementById('mc-result-before').textContent=fmt(total)+' ì›';
  document.getElementById('mc-result-tax').textContent='-'+fmt(tax)+' ì›';
  document.getElementById('mc-result-net').textContent=fmt(net)+' ì›';
  document.getElementById('mc-tax-pct').textContent=(taxRate*100).toFixed(1);
}

function mcSave(){
  const type=document.getElementById('mc-type').value;
  const date=document.getElementById('mc-date').value;
  if(!type){alert('ì—…ë¬´ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.');return;}
  if(!date){alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');return;}
  const name=currentUser.name;
  let hours=0,rate=0,amount=0,detail='',meta={};

  if(type==='mamako-online'){
    const fb=parseInt(document.getElementById('mc-fb')?.value)||0;
    const att=parseInt(document.getElementById('mc-att')?.value)||0;
    const editH=parseFloat(document.getElementById('mc-edit')?.value)||0;
    amount=(fb+att)*2000+Math.floor(editH*12000);
    if(amount===0){alert('í”¼ë“œë°±/ì°¸ì—¬ ê±´ìˆ˜ ë˜ëŠ” ì†Œìš” ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
    hours=editH; rate=0;
    const parts=[];
    if(fb>0||att>0)parts.push(`í”¼ë“œë°±${fb}ê±´+ì°¸ì—¬${att}íšŒ`);
    if(editH>0)parts.push(`ìˆ˜ì •/ê²Œì‹œ${editH}h`);
    detail=parts.join(' / ');
    meta={feedback:fb,attend:att,editH};

  } else if(type==='mamako-qa'){
    const qa=parseInt(document.getElementById('mc-qa')?.value)||0;
    if(qa===0){alert('ì§ˆë‹µ ê±´ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
    amount=calcQA(qa);
    detail=`ì§ˆë‹µ ${qa}ê±´`;
    meta={qa};

  } else if(type==='ta'){
    hours=parseFloat(document.getElementById('mc-hours')?.value)||0;
    rate=parseInt(document.getElementById('mc-rate')?.value)||10000;
    if(hours===0){alert('ì¶œê·¼ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
    amount=Math.floor(hours*rate);
    detail=`í˜„ì¥ ${hours}h`;

  } else if(type==='lab'){
    hours=parseFloat(document.getElementById('mc-hours')?.value)||0;
    rate=parseInt(document.getElementById('mc-rate')?.value)||10000;
    detail=(document.getElementById('mc-detail')?.value||'').trim();
    if(hours===0){alert('ê·¼ë¬´ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
    if(!detail){alert('ì—…ë¬´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');document.getElementById('mc-detail')?.focus();return;}
    amount=Math.floor(hours*rate);
  }

  const entry={date,name,type,hours,rate,amount,detail,note:'',meta};
  mergeAndSaveWork(entry,null);
  fillMonthFilter();
  renderMemberHome();

  // ì…ë ¥ ì´ˆê¸°í™”
  document.getElementById('mc-type').value='';
  document.getElementById('mc-inputs').innerHTML='';
  document.getElementById('mc-result-box').style.display='none';
  const msg=document.getElementById('mc-save-msg');
  msg.textContent=`âœ“ ${date} ê¸°ë¡ ì™„ë£Œ! (ì„¸ì „ ${fmt(amount)}ì›)`;
  setTimeout(()=>{msg.textContent='';},3000);
}

function renderMemberHome(){
  if(!currentUser||currentUser.role!=='member') return;
  const name=currentUser.name;
  document.getElementById('member-home-title').textContent=`ì•ˆë…•í•˜ì„¸ìš”, ${name}ë‹˜ ğŸ‘‹`;
  document.getElementById('member-home-sub').textContent='ì •ì‚° ë‚´ìš©ì„ ê¸°ë¡í•˜ê³  í™•ì¸í•˜ì„¸ìš”';

  // ë‚ ì§œ ê¸°ë³¸ê°’
  const todayEl=document.getElementById('mc-date');
  if(todayEl&&!todayEl.value) todayEl.value=new Date().toISOString().split('T')[0];

  // ì›” í•„í„° ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
  const myReports=workReports.filter(w=>w.name===name);
  const months=[...new Set(myReports.map(w=>w.date.slice(0,7)))].sort().reverse();
  const mf=document.getElementById('mc-month-filter');
  if(mf){
    const now=new Date(),curM=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const allMonths=months.includes(curM)?months:[curM,...months];
    mf.innerHTML=allMonths.map(m=>`<option value="${m}">${m}</option>`).join('');
  }

  // ì •ì‚°í˜„í™© ë…„/ì›” ì…€ë ‰íŠ¸
  const sy=document.getElementById('mc-sy'),sm=document.getElementById('mc-sm');
  if(sy&&sm){
    const now=new Date();
    if(!sy.innerHTML){
      sy.innerHTML='';
      for(let y=now.getFullYear();y>=now.getFullYear()-2;y--)
        sy.innerHTML+=`<option value="${y}" ${y===now.getFullYear()?'selected':''}>${y}ë…„</option>`;
      sm.innerHTML='';
      for(let mo=1;mo<=12;mo++)
        sm.innerHTML+=`<option value="${mo}" ${mo===now.getMonth()+1?'selected':''}>${mo}ì›”</option>`;
    }
  }

  _renderMcSettle();
}

function _renderMcSettle(){
  const name=currentUser.name;
  const year=document.getElementById('mc-sy')?.value||new Date().getFullYear();
  const month=String(document.getElementById('mc-sm')?.value||new Date().getMonth()+1).padStart(2,'0');
  const prefix=`${year}-${month}`;
  let list=workReports.filter(w=>w.name===name&&w.date.startsWith(prefix));
  list=list.sort((a,b)=>a.date.localeCompare(b.date));
  const before=list.reduce((s,w)=>s+w.amount,0);
  const tax=Math.floor(before*taxRate);
  const net=before-tax;
  document.getElementById('mc-st-before').textContent=fmt(before);
  document.getElementById('mc-st-tax').textContent=fmt(tax);
  document.getElementById('mc-st-net').textContent=fmt(net);
  const tbody=document.getElementById('mc-settle-tbody');
  if(!tbody)return;
  tbody.innerHTML=list.map(w=>{
    const idx=workReports.indexOf(w);
    return `<tr>
      <td>${w.date}</td>
      <td>${typeBadge(w.type)}</td>
      <td style="font-size:12px;color:var(--text2);">${w.detail||'-'}</td>
      <td style="font-family:'Space Mono',monospace;">${w.hours||0}h</td>
      <td class="amount-before">${fmt(w.amount)}ì›</td>
      <td style="white-space:nowrap;">
        <button class="btn btn-secondary btn-sm" onclick="mcEditOpen(${idx})">ìˆ˜ì •</button>
        <button class="btn btn-danger btn-sm" onclick="mcEditDel(${idx})" style="margin-left:4px;">ì‚­ì œ</button>
      </td>
    </tr>`;
  }).join('')||'<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:20px;">í•´ë‹¹ ì›” ê¸°ë¡ ì—†ìŒ</td></tr>';
}

// â”€â”€ ì¡°êµ ìˆ˜ì •/ì‚­ì œ â”€â”€
let _mcEditIdx=null;
const MC_RATES=[10000,11000,12000,13000,14000,15000,16000,17000,18000,19000,20000];
function _mcRateSel(selVal){
  return MC_RATES.map(r=>`<option value="${r}" ${r==selVal?'selected':''}>${r.toLocaleString('ko-KR')}ì›/h</option>`).join('');
}

function mcEditOpen(idx){
  _mcEditIdx=idx;
  const w=workReports[idx];
  document.getElementById('mce-date').value=w.date;
  const typeEl=document.getElementById('mce-type');
  typeEl.value=w.type;
  mceTypeChange();
  setTimeout(()=>{
    if(w.type==='ta'||w.type==='lab'){
      const h=document.getElementById('mce-hours');const r=document.getElementById('mce-rate');
      if(h)h.value=w.hours||0;
      if(r)[...r.options].forEach(o=>{if(parseInt(o.value)===w.rate)o.selected=true;});
      if(w.type==='lab'){const d=document.getElementById('mce-detail');if(d)d.value=w.detail||'';}
    } else if(w.type==='mamako-qa'){
      const q=document.getElementById('mce-qa');if(q)q.value=w.meta?.qa||0;
    } else if(w.type==='mamako-online'){
      const fb=document.getElementById('mce-fb'),att=document.getElementById('mce-att'),ed=document.getElementById('mce-edit');
      if(fb)fb.value=w.meta?.feedback||0;if(att)att.value=w.meta?.attend||0;if(ed)ed.value=w.meta?.editH||0;
    }
    mceCalc();
    document.getElementById('mce-amount').value=w.amount;
  },0);
  document.getElementById('modal-mc-edit').classList.add('open');
}

function mceTypeChange(){
  const type=document.getElementById('mce-type').value;
  let html='';
  if(type==='ta'||type==='lab'){
    html=`<div class="form-row c2">
      <div class="form-group"><label>${type==='ta'?'ì¶œê·¼':'ê·¼ë¬´'} ì‹œê°„</label>
        <input type="number" id="mce-hours" value="0" min="0" step="0.5" oninput="mceCalc()" style="font-family:'Space Mono',monospace;font-size:18px;padding:10px 14px;">
      </div>
      <div class="form-group"><label>ì‹œê¸‰</label>
        <select id="mce-rate" onchange="mceCalc()" style="font-family:'Space Mono',monospace;">${_mcRateSel(10000)}</select>
      </div>
    </div>
    ${type==='lab'?`<div class="form-group" style="margin-top:10px;"><label>ì—…ë¬´ ë‚´ìš© <span style="color:var(--danger);font-weight:400;">(í•„ìˆ˜)</span></label><input type="text" id="mce-detail" placeholder="ì—…ë¬´ ë‚´ìš©" style="border-color:var(--accent);"></div>`:''}`;
  } else if(type==='mamako-qa'){
    html=`<div class="form-group"><label>ì§ˆë‹µ ê±´ìˆ˜</label>
      <input type="number" id="mce-qa" value="0" min="0" oninput="mceCalc()" style="font-family:'Space Mono',monospace;font-size:18px;padding:10px 14px;">
      <div style="font-size:11px;color:var(--text3);margin-top:4px;">100ê°œ ë¯¸ë§Œ: 800ì›/ê±´ | 100ê°œ ì´ìƒ: 1,000ì›/ê±´</div>
    </div>`;
  } else if(type==='mamako-online'){
    html=`<div class="form-row c2">
      <div class="form-group"><label>í”¼ë“œë°± ê±´ìˆ˜</label><input type="number" id="mce-fb" value="0" min="0" oninput="mceCalc()" style="font-family:'Space Mono',monospace;"></div>
      <div class="form-group"><label>ì°¸ì—¬ íšŸìˆ˜</label><input type="number" id="mce-att" value="0" min="0" oninput="mceCalc()" style="font-family:'Space Mono',monospace;"></div>
    </div>
    <div class="form-group" style="margin-top:10px;"><label>ìˆ˜ì •/ê²Œì‹œ ì‹œê°„</label>
      <input type="number" id="mce-edit" value="0" min="0" step="0.5" oninput="mceCalc()" style="font-family:'Space Mono',monospace;">
      <div style="font-size:11px;color:var(--text3);margin-top:4px;">ì‹œê°„ Ã— 12,000ì›</div>
    </div>`;
  }
  document.getElementById('mce-inputs').innerHTML=html;
  mceCalc();
}

function mceCalc(){
  const type=document.getElementById('mce-type').value;
  let amt=0;
  if(type==='ta'||type==='lab'){
    const h=parseFloat(document.getElementById('mce-hours')?.value)||0;
    const r=parseInt(document.getElementById('mce-rate')?.value)||10000;
    amt=Math.floor(h*r);
  } else if(type==='mamako-qa'){
    amt=calcQA(parseInt(document.getElementById('mce-qa')?.value)||0);
  } else if(type==='mamako-online'){
    const fb=parseInt(document.getElementById('mce-fb')?.value)||0;
    const att=parseInt(document.getElementById('mce-att')?.value)||0;
    const ed=parseFloat(document.getElementById('mce-edit')?.value)||0;
    amt=(fb+att)*2000+Math.floor(ed*12000);
  }
  const el=document.getElementById('mce-amount');if(el)el.value=amt;
}

function mcEditSave(){
  const type=document.getElementById('mce-type').value;
  const date=document.getElementById('mce-date').value;
  if(!date){alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');return;}
  let hours=0,rate=0,amount=0,detail='',meta={};
  if(type==='ta'||type==='lab'){
    hours=parseFloat(document.getElementById('mce-hours')?.value)||0;
    rate=parseInt(document.getElementById('mce-rate')?.value)||10000;
    amount=Math.floor(hours*rate);
    if(hours===0){alert('ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
    if(type==='lab'){
      detail=(document.getElementById('mce-detail')?.value||'').trim();
      if(!detail){alert('ì—…ë¬´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
    } else {detail=`í˜„ì¥ ${hours}h`;}
  } else if(type==='mamako-qa'){
    const qa=parseInt(document.getElementById('mce-qa')?.value)||0;
    amount=calcQA(qa);detail=`ì§ˆë‹µ ${qa}ê±´`;meta={qa};
  } else if(type==='mamako-online'){
    const fb=parseInt(document.getElementById('mce-fb')?.value)||0;
    const att=parseInt(document.getElementById('mce-att')?.value)||0;
    const ed=parseFloat(document.getElementById('mce-edit')?.value)||0;
    amount=(fb+att)*2000+Math.floor(ed*12000);
    const pts=[];if(fb>0||att>0)pts.push(`í”¼ë“œë°±${fb}ê±´+ì°¸ì—¬${att}íšŒ`);if(ed>0)pts.push(`ìˆ˜ì •/ê²Œì‹œ${ed}h`);
    detail=pts.join(' / ');meta={feedback:fb,attend:att,editH:ed};
  }
  if(amount===0){alert('ê¸ˆì•¡ì´ 0ì›ì…ë‹ˆë‹¤. ì…ë ¥ê°’ì„ í™•ì¸í•˜ì„¸ìš”.');return;}
  const entry={date,name:currentUser.name,type,hours,rate,amount,detail,note:'',meta};
  mergeAndSaveWork(entry,_mcEditIdx);
  fillMonthFilter();renderMemberHome();
  closeModal('modal-mc-edit');notif('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function mcEditDel(idx){
  if(!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?'))return;
  mergeAndDeleteWork(idx);fillMonthFilter();renderMemberHome();notif('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// â”€â”€â”€ MYPAGE â”€â”€â”€
function renderMypage(){
  if(!currentUser||currentUser.role!=='member') return;
  const m=members.find(x=>x.name===currentUser.name);
  const r=m?m.rate||0:0;
  document.getElementById('my-current-rate').textContent=r?r.toLocaleString('ko-KR'):'-';
  document.getElementById('my-rate-input').value=r||'';
  document.getElementById('mypage-sub').textContent=`${currentUser.name}ë‹˜ì˜ ì‹œê¸‰ì„ ì§ì ‘ ë“±ë¡í•˜ì„¸ìš”`;
  document.getElementById('my-rate-msg').textContent='';
}
function saveMyRate(){
  const val=parseInt(document.getElementById('my-rate-input').value)||0;
  if(val<1000||val>100000){
    const msg=document.getElementById('my-rate-msg');
    msg.style.color='var(--danger)';
    msg.textContent='1,000ì› ~ 100,000ì› ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    return;
  }
  // ë³‘í•© ì €ì¥ (ë™ì‹œ ì¶©ëŒ ë°©ì§€)
  const latestM=localStorage.getItem('ta_m');
  if(latestM) members=JSON.parse(latestM);
  const m=members.find(x=>x.name===currentUser.name);
  if(!m){notif('ë“±ë¡ëœ ì¡°êµ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', false);return;}
  m.rate=val;
  persist();
  renderMypage();
  initMamakoForUser();
  const msg=document.getElementById('my-rate-msg');
  msg.style.color='var(--success)';
  msg.textContent=`âœ“ ì‹œê¸‰ ${val.toLocaleString('ko-KR')}ì›ìœ¼ë¡œ ì €ì¥ëìŠµë‹ˆë‹¤!`;
  notif('ì‹œê¸‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// â”€â”€â”€ INIT â”€â”€â”€
function init(){
  // Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ
  const run = () => {
    const db = window._fbDb, fbRef = window._fbRef, fbGet = window._fbGet;
    if(!db){ console.warn('Firebase not ready'); return; }

    showLoadingOverlay(true);

    fbGet(fbRef(db, 'ta')).then(snapshot => {
      const data = snapshot.val();
      if(data){
        members     = data.members     ? Object.values(data.members)     : INIT_MEMBERS.map(m=>({...m}));
        workReports = data.workReports ? Object.values(data.workReports) : [];
        if(data.adminPw)  adminPw  = data.adminPw;
        if(data.taxRate)  taxRate  = parseFloat(data.taxRate);
      } else {
        // ìµœì´ˆ ì‹¤í–‰: ê¸°ë³¸ ë°ì´í„° Firebaseì— ì €ì¥
        members = INIT_MEMBERS.map(m=>({...m}));
        workReports = [];
        persistToFirebase();
      }
      members.forEach(m=>{ if(!m.rate) m.rate=10000; });
      showLoadingOverlay(false);
      if(window._afterInit) window._afterInit();
    }).catch(err => {
      console.error('Firebase load error:', err);
      // í´ë°±: localStorage
      const sm=localStorage.getItem('ta_m'), sw=localStorage.getItem('ta_w'),
            sp=localStorage.getItem('ta_pw'), st=localStorage.getItem('ta_tax');
      members=sm?JSON.parse(sm):INIT_MEMBERS.map(m=>({...m}));
      workReports=sw?JSON.parse(sw):[];
      if(sp) adminPw=sp;
      if(st) taxRate=parseFloat(st);
      members.forEach(m=>{if(!m.rate)m.rate=10000;});
      showLoadingOverlay(false);
      notif('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ (ë°ì´í„° ë™ê¸°í™” ì•ˆ ë¨)', false);
      if(window._afterInit) window._afterInit();
    });
  };

  if(window._firebaseReady) run();
  else window._pendingInit = run;
}

function showLoadingOverlay(show){
  let el = document.getElementById('fb-loading');
  if(!el){
    el = document.createElement('div');
    el.id = 'fb-loading';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(13,15,20,.92);display:flex;align-items:center;justify-content:center;z-index:9999;font-family:Noto Sans KR,sans-serif;flex-direction:column;gap:14px;';
    el.innerHTML = '<div style="width:36px;height:36px;border:3px solid #2a2f3d;border-top-color:#4f8ef7;border-radius:50%;animation:spin .8s linear infinite;"></div><div style="color:#8b91a7;font-size:13px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div><style>@keyframes spin{to{transform:rotate(360deg)}}</style>';
    document.body.appendChild(el);
  }
  el.style.display = show ? 'flex' : 'none';
}
function persist(){
  // localStorage ë°±ì—…
  try{
    localStorage.setItem('ta_m',JSON.stringify(members));
    localStorage.setItem('ta_w',JSON.stringify(workReports));
    localStorage.setItem('ta_pw',adminPw);
    localStorage.setItem('ta_tax',taxRate);
  }catch(e){}
  const ts = Date.now().toString();
  _lastUpdate = ts;
  persistToFirebase();
}

function persistToFirebase(){
  const db = window._fbDb, fbRef = window._fbRef, fbSet = window._fbSet;
  if(!db) return;
  const ts = Date.now().toString();
  _lastUpdate = ts;
  fbSet(fbRef(db, 'ta'), {
    members:     members,
    workReports: workReports,
    adminPw:     adminPw,
    taxRate:     taxRate,
    updatedAt:   ts
  }).catch(err => console.error('Firebase save error:', err));
}

// ë™ì‹œ ì €ì¥ ì¶©ëŒ ë°©ì§€: Firebase ìµœì‹ ê°’ê³¼ ë³‘í•© í›„ ì €ì¥
function mergeAndSaveWork(newEntry, replaceIdx){
  const db = window._fbDb, fbRef = window._fbRef, fbGet = window._fbGet;
  if(!db){ _localMergeWork(newEntry,replaceIdx); return; }
  fbGet(fbRef(db,'ta/workReports')).then(snap=>{
    if(snap.val()) workReports = Object.values(snap.val());
    if(replaceIdx!==null&&replaceIdx!==undefined) workReports[replaceIdx]=newEntry;
    else workReports.push(newEntry);
    persist();
  }).catch(()=>{ _localMergeWork(newEntry,replaceIdx); });
}
function _localMergeWork(newEntry,replaceIdx){
  if(replaceIdx!==null&&replaceIdx!==undefined) workReports[replaceIdx]=newEntry;
  else workReports.push(newEntry);
  persist();
}
function mergeAndDeleteWork(idx){
  const db = window._fbDb, fbRef = window._fbRef, fbGet = window._fbGet;
  if(!db){ workReports.splice(idx,1); persist(); return; }
  fbGet(fbRef(db,'ta/workReports')).then(snap=>{
    if(snap.val()) workReports=Object.values(snap.val());
    workReports.splice(idx,1);
    persist();
  }).catch(()=>{ workReports.splice(idx,1); persist(); });
}
function mergeAndSaveMember(newEntry, replaceIdx){
  const db = window._fbDb, fbRef = window._fbRef, fbGet = window._fbGet;
  if(!db){ _localMergeMember(newEntry,replaceIdx); return; }
  fbGet(fbRef(db,'ta/members')).then(snap=>{
    if(snap.val()) members=Object.values(snap.val());
    if(replaceIdx!==null&&replaceIdx!==undefined) members[replaceIdx]=newEntry;
    else members.push(newEntry);
    persist();
  }).catch(()=>{ _localMergeMember(newEntry,replaceIdx); });
}
function _localMergeMember(newEntry,replaceIdx){
  if(replaceIdx!==null&&replaceIdx!==undefined) members[replaceIdx]=newEntry;
  else members.push(newEntry);
  persist();
}
function mergeAndDeleteMember(idx){
  const db = window._fbDb, fbRef = window._fbRef, fbGet = window._fbGet;
  if(!db){ members.splice(idx,1); persist(); return; }
  fbGet(fbRef(db,'ta/members')).then(snap=>{
    if(snap.val()) members=Object.values(snap.val());
    members.splice(idx,1);
    persist();
  }).catch(()=>{ members.splice(idx,1); persist(); });
}

// â”€â”€â”€ ì‹¤ì‹œê°„ ë™ê¸°í™” (Firebase onValue ë¦¬ìŠ¤ë„ˆ) â”€â”€â”€
let _lastUpdate = Date.now().toString();
let _fbListenerAttached = false;
function startSyncPolling(){
  const db = window._fbDb, fbRef = window._fbRef, fbOnValue = window._fbOnValue;
  if(!db || _fbListenerAttached) return;
  _fbListenerAttached = true;

  fbOnValue(fbRef(db, 'ta'), (snapshot) => {
    if(!currentUser) return;
    const data = snapshot.val();
    if(!data) return;
    const ts = data.updatedAt || '';
    if(ts && ts === _lastUpdate) return; // ë‚´ê°€ ë°©ê¸ˆ ì €ì¥í•œ ê²ƒ â†’ ë¬´ì‹œ
    _lastUpdate = ts;

    // ë‹¤ë¥¸ ê¸°ê¸°/ì‚¬ìš©ìê°€ ë³€ê²½ â†’ ë°ì´í„° ê°±ì‹ 
    if(data.members)     members     = Object.values(data.members);
    if(data.workReports) workReports = Object.values(data.workReports);
    if(data.taxRate)     taxRate     = parseFloat(data.taxRate);
    members.forEach(m=>{ if(!m.rate) m.rate=10000; });

    fillNameSelects(); fillMonthFilter();
    if(currentUser.role==='admin') renderAll();
    else renderMemberHome();
  });
}
function notif(msg,ok=true){
  const el=document.getElementById('notif');
  el.textContent=(ok?'âœ“ ':'âš  ')+msg;
  el.style.background=ok?'var(--success)':'var(--warning)';
  el.style.display='block';
  setTimeout(()=>el.style.display='none',2500);
}

// â”€â”€â”€ LOGIN â”€â”€â”€
function switchTab(t){
  ['admin','member'].forEach(x=>{
    document.getElementById('tab-'+x).classList.toggle('active',x===t);
    document.getElementById('pane-'+x).style.display=x===t?'':'none';
  });
  document.getElementById('admin-err').style.display='none';
  document.getElementById('member-err').style.display='none';
}
function doAdminLogin(){
  if(document.getElementById('admin-pw').value===adminPw){currentUser={role:'admin'};launchApp();}
  else document.getElementById('admin-err').style.display='block';
}
function doMemberLogin(){
  const pin=document.getElementById('member-pin-input').value.trim();
  if(!pin){document.getElementById('member-err').style.display='block';return;}
  const m=members.find(x=>x.pin&&x.pin===pin);
  if(m){currentUser={role:'member',name:m.name};launchApp();}
  else document.getElementById('member-err').style.display='block';
}
function doLogout(){
  currentUser=null;
  document.getElementById('app').classList.remove('show');
  document.getElementById('login-screen').style.display='';
  document.getElementById('admin-pw').value='';
  const mpi=document.getElementById('member-pin-input');if(mpi)mpi.value='';
  switchTab('admin');
}
function launchApp(){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').classList.add('show');
  const isAdmin=currentUser.role==='admin';
  document.querySelectorAll('.admin-nav,.admin-el,.admin-only').forEach(el=>el.style.display=isAdmin?'':'none');
  document.querySelectorAll('.admin-rate-field').forEach(el=>el.style.display=isAdmin?'':'none');
  document.querySelectorAll('.member-nav').forEach(el=>el.style.display=isAdmin?'none':'');
  document.getElementById('sidebar-who').innerHTML=isAdmin?'<strong>ğŸ”‘ ê´€ë¦¬ì</strong>':`<strong>ğŸ‘¤ ${currentUser.name}</strong>`;
  document.getElementById('dash-sub').textContent=isAdmin?'ì „ì²´ í˜„í™© ìš”ì•½':`${currentUser.name}ë‹˜ì˜ ì—…ë¬´ í˜„í™©`;
  fillNameSelects();fillMonthFilter();fillYearMonth();
  if(currentUser.role==='admin'){
    renderAll();calculate();initMamakoForUser();
    document.getElementById('mw-date').value=new Date().toISOString().split('T')[0];
    onWorkTypeChange();
    showPage('dashboard', document.querySelector('[data-page="dashboard"]'));
  } else {
    // ì¡°êµ: ëª¨ë“  page active ì œê±° í›„ member-homeë§Œ í™œì„±í™”
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById('page-member-home').classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    const navEl=document.querySelector('[data-page="member-home"]');
    if(navEl)navEl.classList.add('active');
    renderMemberHome();
  }
  _lastUpdate = localStorage.getItem('ta_updated') || _lastUpdate;
  startSyncPolling();
}

// â”€â”€â”€ NAV â”€â”€â”€
function showPage(id,el){
  if(id==='mamako-calc')setTimeout(initMamakoForUser,0);
  if(id==='mypage')setTimeout(renderMypage,0);
  if(id==='member-home')setTimeout(renderMemberHome,0);
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(el)el.classList.add('active');
}

// â”€â”€â”€ HELPERS â”€â”€â”€
function fillNameSelects(){
  const opts=[...members].sort((a,b)=>a.name.localeCompare(b.name,'ko')).map(m=>`<option value="${m.name}">${m.name}</option>`).join('');
  ['mw-name','smm-name','mm-member-select'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    const pre=id==='mm-member-select'?'<option value="">-- ì¡°êµ ì„ íƒ (ì„ íƒì‚¬í•­) --</option>':'<option value="">-- ì„ íƒ --</option>';
    el.innerHTML=pre+opts;
  });
}
function fillMonthFilter(){
  const months=[...new Set(workReports.map(w=>w.date.slice(0,7)))].sort().reverse();
  document.getElementById('w-month').innerHTML='<option value="">ì „ì²´ ì›”</option>'+months.map(m=>`<option value="${m}">${m}</option>`).join('');
  const names=[...new Set(workReports.map(w=>w.name))].sort();
  document.getElementById('w-name-f').innerHTML='<option value="">ì „ì²´ ì¡°êµ</option>'+names.map(n=>`<option value="${n}">${n}</option>`).join('');
}
function fillYearMonth(){
  const now=new Date();
  let yh='',mh='';
  for(let y=now.getFullYear();y>=now.getFullYear()-3;y--) yh+=`<option value="${y}" ${y===now.getFullYear()?'selected':''}>${y}ë…„</option>`;
  for(let m=1;m<=12;m++) mh+=`<option value="${m}" ${m===now.getMonth()+1?'selected':''}>${m}ì›”</option>`;
  document.getElementById('sy').innerHTML=yh;
  document.getElementById('sm').innerHTML=mh;
}
function fmt(n){return Math.round(n).toLocaleString('ko-KR');}
function typeBadge(t){
  const map={
    'mamako-online':'<span class="badge badge-purple">ë§ˆë§ˆì½”-ì˜¨ë¼ì¸</span>',
    ta:'<span class="badge badge-blue">í˜„ì¥ì¡°êµ</span>',
    'mamako-qa':'<span class="badge badge-orange">ì§ˆì˜ì‘ë‹µ</span>',
    lab:'<span class="badge badge-green">ì—°êµ¬ì‹¤</span>',
    'mamako-edit':'<span class="badge badge-purple">ë§ˆë§ˆì½”-ì˜¨ë¼ì¸</span>',
    'mamako-field':'<span class="badge badge-blue">í˜„ì¥ì¡°êµ</span>',
    mamako:'<span class="badge badge-purple">ë§ˆë§ˆì½”</span>',
  };
  return map[t]||`<span class="badge">${t}</span>`;
}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');}));

// â”€â”€â”€ RENDER ALL â”€â”€â”€
function renderAll(){renderDash();renderWork();renderSettlement();if(currentUser&&currentUser.role==='admin')renderMembers();}

// â”€â”€â”€ DASHBOARD â”€â”€â”€
function renderDash(){
  const isAdmin=currentUser.role==='admin';
  const now=new Date(),prefix=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  let rpts=workReports.filter(w=>w.date&&w.date.startsWith(prefix));
  if(!isAdmin)rpts=rpts.filter(w=>w.name===currentUser.name);
  const before=rpts.reduce((s,w)=>s+(w.amount||0),0),net=Math.floor(before*(1-taxRate));
  document.getElementById('s-members').textContent=isAdmin?members.length:'-';
  document.getElementById('s-count').textContent=rpts.length;
  document.getElementById('s-before').textContent=fmt(before);
  document.getElementById('s-net').textContent=fmt(net);
  const recent=[...rpts].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,8);
  document.getElementById('recent-tbody').innerHTML=recent.map(w=>`<tr><td>${w.date}</td><td><strong>${w.name}</strong></td><td>${typeBadge(w.type)}</td><td style="font-family:'Space Mono',monospace;">${w.hours||'-'}${w.hours?'h':''}</td><td class="amount-before">${fmt(w.amount)}ì›</td></tr>`).join('')||'<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:20px;">ë°ì´í„° ì—†ìŒ</td></tr>';
  const map={};
  rpts.forEach(w=>{if(!map[w.name])map[w.name]={h:0,a:0};map[w.name].h+=(w.hours||0);map[w.name].a+=w.amount;});
  document.getElementById('summary-tbody').innerHTML=Object.entries(map).sort((a,b)=>b[1].a-a[1].a).map(([n,v])=>`<tr><td><strong>${n}</strong></td><td style="font-family:'Space Mono',monospace;">${v.h}h</td><td class="amount-before">${fmt(v.a)}ì›</td><td class="amount-display">${fmt(Math.floor(v.a*(1-taxRate)))}ì›</td></tr>`).join('')||'<tr><td colspan="4" style="text-align:center;color:var(--text3);padding:20px;">ì´ë²ˆ ë‹¬ ë°ì´í„° ì—†ìŒ</td></tr>';
}

// â”€â”€â”€ WORK â”€â”€â”€
function renderWork(){
  const isAdmin=currentUser.role==='admin';
  const search=document.getElementById('w-search').value.toLowerCase();
  const monthF=document.getElementById('w-month').value;
  const nameF=isAdmin?document.getElementById('w-name-f').value:'';
  let list=workReports.filter(w=>{
    const q=search?(w.name+w.date+(w.detail||'')+(w.note||'')).toLowerCase().includes(search):true;
    const m=monthF?w.date.startsWith(monthF):true;
    const n=isAdmin?(nameF?w.name===nameF:true):w.name===currentUser.name;
    return q&&m&&n;
  });
  list.sort((a,b)=>b.date.localeCompare(a.date));
  const ta=list.reduce((s,w)=>s+w.amount,0);
  document.getElementById('work-info').textContent=`ì´ ${list.length}ê±´ | ì„¸ì „ ${fmt(ta)}ì› | ì„¸í›„ ${fmt(Math.floor(ta*(1-taxRate)))}ì›`;
  document.getElementById('work-tbody').innerHTML=list.map(w=>{
    const i=workReports.indexOf(w);
    const adminCell=isAdmin?`<td><button class="btn btn-secondary btn-sm" onclick="openEditWork(${i})">ìˆ˜ì •</button><button class="btn btn-danger btn-sm" onclick="delWork(${i})" style="margin-left:4px;">ì‚­ì œ</button></td>`:'';
    return `<tr><td>${w.date}</td><td><strong>${w.name}</strong></td><td>${typeBadge(w.type)}</td><td style="color:var(--text2);font-size:12px;max-width:150px;white-space:normal;">${w.detail||'-'}</td><td style="font-family:'Space Mono',monospace;">${w.hours||0}h</td><td><span class="rate-chip">${fmt(w.rate||0)}ì›</span></td><td class="amount-before">${fmt(w.amount)}ì›</td><td style="color:var(--text3);font-size:12px;">${w.note||'-'}</td>${adminCell}</tr>`;
  }).join('')||'<tr><td colspan="9" style="text-align:center;color:var(--text3);padding:24px;">ì—…ë¬´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
}

// work modal â€“ dynamic inputs per type
function onWorkTypeChange(){
  const type=document.getElementById('mw-type').value;
  const isM=currentUser&&currentUser.role==='member';
  const memberObj=isM?members.find(x=>x.name===currentUser.name):null;
  const memberRate=memberObj?memberObj.rate||10000:10000;
  let html='';

  if(type==='ta'||type==='mamako-field'){
    // ê°œì¸ ì‹œê¸‰ ìë™ ì ìš© â€” ì¡°êµëŠ” ì½ê¸°ì „ìš©
    const rateAttrs=isM?'readonly style="color:var(--success);background:var(--bg);cursor:not-allowed;"':'oninput="dynCalc()"';
    html=`<div class="form-row c2">
      <div class="form-group">
        <label>ì‹œê°„</label>
        <input type="number" id="dyn-hours" min="0" step="0.5" oninput="dynCalc()" placeholder="0">
      </div>
      <div class="form-group">
        <label>ì‹œê¸‰ (ì›/h)</label>
        <input type="number" id="dyn-rate" value="${memberRate}" ${rateAttrs}>
        ${isM?'<div style="font-size:11px;color:var(--success);margin-top:4px;">âœ“ ë‚´ ì •ë³´ì— ë“±ë¡ëœ ì‹œê¸‰ ìë™ ì ìš©</div>':'<span id="rate-hint" style="font-size:10px;color:var(--text3);margin-top:4px;display:block;"></span>'}
      </div>
    </div>`;

  } else if(type==='lab'){
    // ì—°êµ¬ì‹¤: ì‹œê°„+ì‹œê¸‰ ì§ì ‘ ì…ë ¥ + ì—…ë¬´ ë‚´ìš© í•„ìˆ˜
    html=`<div class="form-row c2">
      <div class="form-group">
        <label>ê·¼ë¬´ ì‹œê°„</label>
        <input type="number" id="dyn-hours" min="0" step="0.5" oninput="dynCalc()" placeholder="0">
      </div>
      <div class="form-group">
        <label>ì‹œê¸‰ (ì›/h)</label>
        <input type="number" id="dyn-rate" value="10000" oninput="dynCalc()">
      </div>
    </div>`;

  } else if(type==='mamako-online'){
    html=`<div class="form-row c2">
      <div class="form-group"><label>í”¼ë“œë°± ê±´ìˆ˜</label><input type="number" id="dyn-fb" value="0" min="0" oninput="dynCalc()"></div>
      <div class="form-group"><label>ì°¸ì—¬ íšŸìˆ˜</label><input type="number" id="dyn-att" value="0" min="0" oninput="dynCalc()"></div>
    </div>
    <div style="font-size:12px;color:var(--text3);margin-bottom:8px;">(í”¼ë“œë°± ê±´ìˆ˜ + ì°¸ì—¬ íšŸìˆ˜) Ã— 2,000ì›</div>`;

  } else if(type==='mamako-edit'){
    html=`<div class="form-group">
      <label>ì†Œìš” ì‹œê°„ (ì‹œê°„) â€” ì‹œê¸‰ 12,000ì› ì ìš©</label>
      <input type="number" id="dyn-hours" min="0" step="0.5" oninput="dynCalc()" placeholder="0">
    </div>`;

  } else if(type==='mamako-qa'){
    html=`<div class="form-group">
      <label>ì§ˆë‹µ ê±´ìˆ˜ (100ê°œ ë¯¸ë§Œ: 800ì›/ê±´ | 100ê°œ ì´ìƒ: 1,000ì›/ê±´)</label>
      <input type="number" id="dyn-qa" value="0" min="0" oninput="dynCalc()">
    </div>
    <div style="font-size:12px;color:var(--text3);margin-bottom:8px;" id="dyn-qa-hint"></div>`;
  }

  document.getElementById('mw-dynamic').innerHTML=html;

  // ìœ í˜•ë³„ ìƒì„¸ë‚´ìš© ë¼ë²¨Â·í”Œë ˆì´ìŠ¤í™€ë”Â·í•„ìˆ˜ì—¬ë¶€ ë³€ê²½
  const detailWrap=document.getElementById('mw-detail-wrap');
  const detailLabel=document.getElementById('mw-detail-label');
  const detailTA=document.getElementById('mw-detail');
  if(type==='lab'){
    detailLabel.innerHTML='ì–´ë–¤ ì—…ë¬´ë¥¼ í–ˆë‚˜ìš”? <span style="color:var(--danger);font-size:11px;">(í•„ìˆ˜)</span>';
    detailTA.placeholder='ì˜ˆ) ë…¼ë¬¸ ìë£Œ ì •ë¦¬, ì„¤ë¬¸ ë°ì´í„° ì…ë ¥, êµìˆ˜ë‹˜ ìë£Œ ë²ˆì—­ ë“±';
    detailTA.style.borderColor='var(--accent)';
    detailTA.style.minHeight='80px';
    detailWrap.style.order='-1'; // ìƒë‹¨ìœ¼ë¡œ ì´ë™
  } else {
    detailLabel.innerHTML='ìƒì„¸ ì—…ë¬´ ë‚´ìš© <span style="color:var(--text3);font-size:11px;">(ì„ íƒ)</span>';
    detailTA.placeholder='ì—…ë¬´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...';
    detailTA.style.borderColor='';
    detailTA.style.minHeight='';
    detailWrap.style.order='';
  }

  if(type==='mamako-online'||type==='mamako-edit'||type==='mamako-qa'){
    document.getElementById('mw-amount').value='';
  }
  dynCalc();
}
function onNameChange(){
  const isM=currentUser.role==='member';
  const name=isM?currentUser.name:document.getElementById('mw-name').value;
  const m=members.find(x=>x.name===name);
  const type=document.getElementById('mw-type').value;
  const rh=document.getElementById('rate-hint');
  const dr=document.getElementById('dyn-rate');
  // ì—°êµ¬ì‹¤ì€ ìë™ ì ìš© ì•ˆ í•¨ â€” ë§¤ë²ˆ ì§ì ‘ ì…ë ¥
  if(type!=='lab'&&m&&dr){
    dr.value=m.rate||10000;
    if(rh)rh.textContent=`(${name}: ${fmt(m.rate||10000)}ì›/h)`;
  } else if(rh) rh.textContent='';
  dynCalc();
}
function dynCalc(){
  const type=document.getElementById('mw-type').value;
  let amt=0;
  if(type==='ta'||type==='lab'||type==='mamako-field'){
    const h=parseFloat(document.getElementById('dyn-hours')?.value)||0;
    const r=parseFloat(document.getElementById('dyn-rate')?.value)||10000;
    amt=Math.floor(h*r);
  } else if(type==='mamako-online'){
    const fb=parseInt(document.getElementById('dyn-fb')?.value)||0;
    const att=parseInt(document.getElementById('dyn-att')?.value)||0;
    amt=(fb+att)*2000;
  } else if(type==='mamako-edit'){
    const h=parseFloat(document.getElementById('dyn-hours')?.value)||0;
    amt=Math.floor(h*12000);
  } else if(type==='mamako-qa'){
    const qa=parseInt(document.getElementById('dyn-qa')?.value)||0;
    amt=calcQA(qa);
    const hint=document.getElementById('dyn-qa-hint');
    if(hint){
      hint.textContent=qa>0?`${qa}ê±´ Ã— 1,000ì› = ${fmt(amt)}ì›`:'';
    }
  }
  document.getElementById('mw-amount').value=amt;
}
function calcQA(n){
  if(n<=0)return 0;
  if(n<100)return n*800;
  return n*1000;
}
function openAddWork(){
  editWorkIdx=null;
  document.getElementById('mw-title').textContent='ì—…ë¬´ ë³´ê³  ì¶”ê°€';
  document.getElementById('mw-date').value=new Date().toISOString().split('T')[0];
  // ì¡°êµ ë¡œê·¸ì¸ ì‹œ ë³¸ì¸ ì´ë¦„ ê³ ì •
  const nameEl=document.getElementById('mw-name');
  const nameDisplay=document.getElementById('mw-name-display');
  if(currentUser.role==='member'){
    nameEl.style.display='none';
    if(nameDisplay){nameDisplay.style.display='';nameDisplay.textContent=currentUser.name;}
  } else {
    nameEl.style.display='';
    nameEl.value='';
    if(nameDisplay)nameDisplay.style.display='none';
  }
  document.getElementById('mw-type').value='ta';
  document.getElementById('mw-detail').value='';
  document.getElementById('mw-amount').value='';
  document.getElementById('mw-note').value='';
  // onWorkTypeChange ì•ˆì—ì„œ isM íŒë‹¨ í›„ ì‹œê¸‰ ìë™ ì„¸íŒ…í•˜ë¯€ë¡œ ë³„ë„ setTimeout ë¶ˆí•„ìš”
  onWorkTypeChange();
  document.getElementById('modal-work').classList.add('open');
}
function openEditWork(idx){
  editWorkIdx=idx;
  const w=workReports[idx];
  document.getElementById('mw-title').textContent='ì—…ë¬´ ë³´ê³  ìˆ˜ì •';
  document.getElementById('mw-date').value=w.date;
  const nameElE=document.getElementById('mw-name');
  const nameDisplayE=document.getElementById('mw-name-display');
  if(currentUser.role==='member'){
    nameElE.style.display='none';
    if(nameDisplayE){nameDisplayE.style.display='';nameDisplayE.textContent=w.name;}
  } else {
    nameElE.style.display='';
    nameElE.value=w.name;
    if(nameDisplayE)nameDisplayE.style.display='none';
  }
  document.getElementById('mw-type').value=w.type;
  document.getElementById('mw-detail').value=w.detail||'';
  document.getElementById('mw-note').value=w.note||'';
  onWorkTypeChange();
  // re-fill dynamic fields (ë™ê¸°: onWorkTypeChange í›„ ë°”ë¡œ ê°’ ë³µì›)
  if(w.type==='ta'||w.type==='lab'||w.type==='mamako-field'){
    const dh=document.getElementById('dyn-hours');const dr=document.getElementById('dyn-rate');
    if(dh)dh.value=w.hours||0;if(dr)dr.value=w.rate||10000;
  } else if(w.type==='mamako-online'){
    const df=document.getElementById('dyn-fb');const da=document.getElementById('dyn-att');
    if(df)df.value=w.meta?.feedback||0;if(da)da.value=w.meta?.attend||0;
  } else if(w.type==='mamako-edit'){
    const dh=document.getElementById('dyn-hours');if(dh)dh.value=w.hours||0;
  } else if(w.type==='mamako-qa'){
    const dq=document.getElementById('dyn-qa');if(dq)dq.value=w.meta?.qa||0;
  }
  dynCalc();
  document.getElementById('mw-amount').value=w.amount;
  document.getElementById('modal-work').classList.add('open');
}
function saveWork(){
  const date=document.getElementById('mw-date').value;
  const isM2=currentUser.role==='member';
  const name=isM2?currentUser.name:document.getElementById('mw-name').value;
  const type=document.getElementById('mw-type').value;
  const detail=document.getElementById('mw-detail').value;
  const note=document.getElementById('mw-note').value;
  const amount=parseInt(document.getElementById('mw-amount').value)||0;
  if(!date){alert('ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
  if(!name){alert('ì´ë¦„ì„ í™•ì¸í•˜ì„¸ìš”.');return;}
  if(type==='lab'&&!detail.trim()){
    alert('ì—°êµ¬ì‹¤ ì—…ë¬´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    document.getElementById('mw-detail').focus();
    return;
  }
  let hours=0,rate=0,meta={};
  if(type==='ta'||type==='lab'||type==='mamako-field'){
    hours=parseFloat(document.getElementById('dyn-hours')?.value)||0;
    rate=parseFloat(document.getElementById('dyn-rate')?.value)||10000;
  } else if(type==='mamako-online'){
    meta={feedback:parseInt(document.getElementById('dyn-fb')?.value)||0,attend:parseInt(document.getElementById('dyn-att')?.value)||0};
  } else if(type==='mamako-edit'){
    hours=parseFloat(document.getElementById('dyn-hours')?.value)||0;rate=12000;
  } else if(type==='mamako-qa'){
    meta={qa:parseInt(document.getElementById('dyn-qa')?.value)||0};
  }
  const entry={date,name,type,hours,rate,amount,detail,note,meta};
  mergeAndSaveWork(entry, editWorkIdx);
  fillMonthFilter();renderAll();closeModal('modal-work');notif('ì—…ë¬´ ë³´ê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}
function delWork(idx){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  mergeAndDeleteWork(idx);fillMonthFilter();renderAll();notif('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// â”€â”€â”€ MAMAKO CALCULATOR â”€â”€â”€
function initMamakoForUser(){
  const fieldRateEl=document.getElementById('mm-field-rate');
  const fieldRateFixed=document.getElementById('mm-field-rate-fixed');
  const memberSelectWrap=document.getElementById('mm-member-select-wrap');
  const labHintEl=document.getElementById('lab-rate-hint');
  if(currentUser&&currentUser.role==='member'){
    const m=members.find(x=>x.name===currentUser.name);
    const r=m?m.rate||10000:10000;
    // í˜„ì¥ ì‹œê¸‰: input ìˆ¨ê¸°ê³  ê³ ì •ê°’ í‘œì‹œ
    if(fieldRateEl){fieldRateEl.value=r;fieldRateEl.style.display='none';}
    if(fieldRateFixed){fieldRateFixed.style.display='';fieldRateFixed.textContent=`${fmt(r)}ì›/h (ì¸ì ì‚¬í•­ ê¸°ì¤€)`;}
    // ì¡°êµ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¹€
    if(memberSelectWrap)memberSelectWrap.style.display='none';
    // ì—°êµ¬ì‹¤ì€ ë§¤ë²ˆ ì…ë ¥ â€” íŒíŠ¸ ì—†ìŒ
    if(labHintEl)labHintEl.textContent='';
  } else {
    if(fieldRateEl)fieldRateEl.style.display='';
    if(fieldRateFixed)fieldRateFixed.style.display='none';
    if(memberSelectWrap)memberSelectWrap.style.display='';
  }
  calcMamako();
}
function calcMamako(){
  const fb=parseInt(document.getElementById('mm-feedback').value)||0;
  const att=parseInt(document.getElementById('mm-attend').value)||0;
  const editH=parseFloat(document.getElementById('mm-edit-hours').value)||0;
  const qa=parseInt(document.getElementById('mm-qa').value)||0;
  const fieldH=parseFloat(document.getElementById('mm-field-hours').value)||0;
  const fieldR=parseFloat(document.getElementById('mm-field-rate').value)||10000;
  const labH=parseFloat(document.getElementById('mm-lab-hours').value)||0;
  // ì—°êµ¬ì‹¤ ì‹œê¸‰: ë§¤ë²ˆ ì§ì ‘ ì…ë ¥í•œ ê°’ ì‚¬ìš©
  const labRate=parseFloat(document.getElementById('mm-lab-rate')?.value)||10000;

  const rFeedback=(fb+att)*2000;
  const rEdit=Math.floor(editH*12000);
  const rQA=calcQA(qa);
  const rField=Math.floor(fieldH*fieldR);
  const rLab=Math.floor(labH*labRate);
  const total=rFeedback+rEdit+rQA+rField+rLab;
  const tax=Math.floor(total*taxRate);
  const net=total-tax;

  // QA breakdown hint
  const qaHint=document.getElementById('qa-breakdown');
  if(qa===0) qaHint.textContent='';
  else if(qa<=100) qaHint.textContent=`${qa}ê±´ Ã— 1,000ì› = ${fmt(rQA)}ì›`;
  else qaHint.textContent=`${qa}ê±´ Ã— 1,000ì› = ${fmt(rQA)}ì›`;

  document.getElementById('mm-total-before').textContent=fmt(total)+' ì›';
  document.getElementById('r-feedback').textContent=fmt(rFeedback)+' ì›';
  document.getElementById('r-edit').textContent=fmt(rEdit)+' ì›';
  document.getElementById('r-qa').textContent=fmt(rQA)+' ì›';
  document.getElementById('r-field').textContent=fmt(rField)+' ì›';
  const labEl=document.getElementById('r-lab');if(labEl)labEl.textContent=fmt(rLab)+' ì›';
  document.getElementById('r-before2').textContent=fmt(total)+' ì›';
  document.getElementById('r-tax').textContent='-'+fmt(tax)+' ì›';
  document.getElementById('r-net').textContent=fmt(net)+' ì›';
  document.getElementById('mm-tax-pct').textContent=(taxRate*100).toFixed(1);

  // Summary lines
  const lines=[];
  if(fb>0)lines.push(`í”¼ë“œë°± ${fb}ê±´ Ã— 2,000 = ${fmt(fb*2000)}ì›`);
  if(att>0)lines.push(`ì°¸ì—¬ ${att}íšŒ Ã— 2,000 = ${fmt(att*2000)}ì›`);
  if(editH>0)lines.push(`ìˆ˜ì •/ê²Œì‹œ/ëˆ„ë½/í˜„í™© ${editH}h Ã— 12,000 = ${fmt(rEdit)}ì›`);
  if(qa>0)lines.push(`ì§ˆë‹µ ${qa}ê±´ = ${fmt(rQA)}ì›`);
  if(fieldH>0)lines.push(`í˜„ì¥ ${fieldH}h Ã— ${fmt(fieldR)}ì› = ${fmt(rField)}ì›`);
  if(labH>0)lines.push(`ì—°êµ¬ì‹¤ ${labH}h Ã— ${fmt(labRate)}ì› = ${fmt(rLab)}ì›`);
  // ì—°êµ¬ì‹¤: ì…ë ¥ê°’ ì‹¤ì‹œê°„ ê³„ì‚° ê²°ê³¼ íŒíŠ¸
  const labHintEl=document.getElementById('lab-rate-hint');
  if(labHintEl&&labH>0){
    labHintEl.textContent=`${labH}h Ã— ${fmt(labRate)}ì› = ${fmt(rLab)}ì›`;
  } else if(labHintEl){labHintEl.textContent='';}
  document.getElementById('mm-summary-lines').innerHTML=lines.length?lines.map(l=>`<div style="color:var(--text2);">â€¢ ${l}</div>`).join(''):`<div style="color:var(--text3);">ì…ë ¥ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
}
function onMamakoMemberChange(){
  const name=document.getElementById('mm-member-select').value;
  const m=members.find(x=>x.name===name);
  if(m&&m.rate){document.getElementById('mm-field-rate').value=m.rate;}
  calcMamako();
}
function resetMamako(){
  ['mm-feedback','mm-attend','mm-edit-hours','mm-qa','mm-field-hours','mm-lab-hours'].forEach(id=>document.getElementById(id).value=0);
  const mlr=document.getElementById('mm-lab-rate');if(mlr)mlr.value=10000;
  document.getElementById('mm-field-rate').value=10000;
  const mms=document.getElementById('mm-member-select');if(mms)mms.value='';
  calcMamako();
}
function openSaveMamakoModal(){
  const fb=parseInt(document.getElementById('mm-feedback').value)||0;
  const att=parseInt(document.getElementById('mm-attend').value)||0;
  const editH=parseFloat(document.getElementById('mm-edit-hours').value)||0;
  const qa=parseInt(document.getElementById('mm-qa').value)||0;
  const fieldH=parseFloat(document.getElementById('mm-field-hours').value)||0;
  const fieldR=parseFloat(document.getElementById('mm-field-rate').value)||10000;
  const labH3=parseFloat(document.getElementById('mm-lab-hours').value)||0;
  const labR3=parseFloat(document.getElementById('mm-lab-rate')?.value)||10000;
  const total=(fb+att)*2000+Math.floor(editH*12000)+calcQA(qa)+Math.floor(fieldH*fieldR)+Math.floor(labH3*labR3);
  if(total===0){alert('ê³„ì‚°ëœ ê¸ˆì•¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë‚´ì—­ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  document.getElementById('smm-date').value=new Date().toISOString().split('T')[0];
  const smmNameEl=document.getElementById('smm-name');
  const smmNameDisplay=document.getElementById('smm-name-display');
  if(currentUser.role==='member'){
    smmNameEl.style.display='none';
    if(smmNameDisplay){smmNameDisplay.style.display='';smmNameDisplay.textContent=currentUser.name;}
  } else {
    smmNameEl.style.display='';smmNameEl.value='';
    if(smmNameDisplay)smmNameDisplay.style.display='none';
  }
  document.getElementById('smm-note').value='';
  const lines=[];
  if(fb>0||att>0)lines.push(`ì˜¨ë¼ì¸ í”¼ë“œë°± ${fb}ê±´ + ì°¸ì—¬ ${att}íšŒ = ${fmt((fb+att)*2000)}ì›`);
  if(editH>0)lines.push(`ìˆ˜ì •/ê²Œì‹œ/ëˆ„ë½/í˜„í™© ${editH}h = ${fmt(Math.floor(editH*12000))}ì›`);
  if(qa>0)lines.push(`ì§ˆë‹µ ${qa}ê±´ = ${fmt(calcQA(qa))}ì›`);
  if(fieldH>0)lines.push(`í˜„ì¥ ${fieldH}h = ${fmt(Math.floor(fieldH*fieldR))}ì›`);
  if(labH3>0)lines.push(`ì—°êµ¬ì‹¤ ${labH3}h = ${fmt(Math.floor(labH3*labR3))}ì›`);
  document.getElementById('smm-preview').innerHTML=`
    <div style="margin-bottom:10px;">${lines.map(l=>`<div style="font-size:12px;color:var(--text2);margin-bottom:4px;">â€¢ ${l}</div>`).join('')}</div>
    <div style="display:flex;justify-content:space-between;border-top:1px solid var(--border);padding-top:10px;">
      <span style="font-weight:700;">ì„¸ì „ í•©ê³„</span>
      <span style="font-family:'Space Mono',monospace;font-weight:700;color:var(--accent2);">${fmt(total)}ì›</span>
    </div>`;
  document.getElementById('modal-save-mamako').classList.add('open');
}
function saveMamakoToWork(){
  const date=document.getElementById('smm-date').value;
  const name=currentUser.role==='member'?currentUser.name:document.getElementById('smm-name').value;
  const note=document.getElementById('smm-note').value;
  if(!date||!name){alert('ë‚ ì§œì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  const fb=parseInt(document.getElementById('mm-feedback').value)||0;
  const att=parseInt(document.getElementById('mm-attend').value)||0;
  const editH=parseFloat(document.getElementById('mm-edit-hours').value)||0;
  const qa=parseInt(document.getElementById('mm-qa').value)||0;
  const fieldH=parseFloat(document.getElementById('mm-field-hours').value)||0;
  const fieldR=parseFloat(document.getElementById('mm-field-rate').value)||10000;
  const labH2=parseFloat(document.getElementById('mm-lab-hours').value)||0;
  const labR2=parseFloat(document.getElementById('mm-lab-rate')?.value)||10000;
  const amount=(fb+att)*2000+Math.floor(editH*12000)+calcQA(qa)+Math.floor(fieldH*fieldR)+Math.floor(labH2*labR2);
  const detail=[];
  if(fb>0||att>0)detail.push(`í”¼ë“œë°±${fb}ê±´+ì°¸ì—¬${att}íšŒ`);
  if(editH>0)detail.push(`ìˆ˜ì •/ê²Œì‹œ${editH}h`);
  if(qa>0)detail.push(`ì§ˆë‹µ${qa}ê±´`);
  if(fieldH>0)detail.push(`í˜„ì¥${fieldH}h`);
  if(labH2>0)detail.push(`ì—°êµ¬ì‹¤${labH2}h`);
  const entry={date,name,type:'mamako-online',hours:editH+fieldH+labH2,rate:0,amount,detail:detail.join(' / '),note,meta:{feedback:fb,attend:att,editH,qa,fieldH,fieldR,labH:labH2,labR:labR2}};
  mergeAndSaveWork(entry, null);
  fillMonthFilter();renderAll();
  closeModal('modal-save-mamako');
  notif('ë§ˆë§ˆì½” ë‚´ì—­ì´ ì—…ë¬´ë‚´ì—­ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// â”€â”€â”€ SETTLEMENT â”€â”€â”€
function renderSettlement(){
  const isAdmin=currentUser.role==='admin';
  const year=document.getElementById('sy').value,month=String(document.getElementById('sm').value).padStart(2,'0');
  const prefix=`${year}-${month}`;
  let list=workReports.filter(w=>w.date&&w.date.startsWith(prefix));
  if(!isAdmin)list=list.filter(w=>w.name===currentUser.name);
  const map={};
  list.forEach(w=>{if(!map[w.name])map[w.name]={h:0,a:0};map[w.name].h+=(w.hours||0);map[w.name].a+=w.amount;});
  const rows=isAdmin?members.filter(m=>map[m.name]).sort((a,b)=>a.name.localeCompare(b.name,'ko')):(map[currentUser.name]?[{name:currentUser.name,account:''}]:[]);
  let tb=0,tt=0,tn=0;
  const html=rows.map((m,i)=>{
    const d=map[m.name];if(!d)return'';
    const tax=Math.floor(d.a*taxRate),net=d.a-tax;
    tb+=d.a;tt+=tax;tn+=net;
    const acct=isAdmin?`<td style="font-size:11px;color:var(--text3);max-width:160px;white-space:normal;">${m.account||'-'}</td>`:'';
    return `<tr><td style="color:var(--text3);">${i+1}</td><td><strong>${m.name}</strong></td><td style="font-family:'Space Mono',monospace;">${d.h}h</td><td class="amount-before">${fmt(d.a)}ì›</td><td><span class="tax-badge">-${fmt(tax)}ì›</span></td><td class="amount-display">${fmt(net)}ì›</td>${acct}</tr>`;
  }).join('');
  document.getElementById('settle-tbody').innerHTML=html||`<tr><td colspan="7" style="text-align:center;color:var(--text3);padding:24px;">${year}ë…„ ${parseInt(month)}ì›” ì •ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>`;
  document.getElementById('st-before').textContent=fmt(tb);
  document.getElementById('st-tax').textContent=fmt(tt);
  document.getElementById('st-net').textContent=fmt(tn);
}
function exportCSV(){
  const year=document.getElementById('sy').value,month=String(document.getElementById('sm').value).padStart(2,'0');
  const list=workReports.filter(w=>w.date&&w.date.startsWith(`${year}-${month}`));
  const map={};list.forEach(w=>{if(!map[w.name])map[w.name]={h:0,a:0};map[w.name].h+=(w.hours||0);map[w.name].a+=w.amount;});
  let csv='ìˆœë²ˆ,ì´ë¦„,ì´ ì‹œê°„,ì„¸ì „ ê¸ˆì•¡,ê³µì œì•¡,ì‹¤ì§€ê¸‰ì•¡,ì…ê¸ˆ ê³„ì¢Œ\n';
  members.filter(m=>map[m.name]).sort((a,b)=>a.name.localeCompare(b.name,'ko')).forEach((m,i)=>{
    const d=map[m.name],tax=Math.floor(d.a*taxRate),net=d.a-tax;
    csv+=`${i+1},${m.name},${d.h},${d.a},${tax},${net},"${m.account||''}"\n`;
  });
  const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`ì •ì‚°í˜„í™©_${year}ë…„${parseInt(month)}ì›”.csv`;a.click();
  notif('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// â”€â”€â”€ MEMBERS â”€â”€â”€
function renderMembers(){
  const search=document.getElementById('m-search').value.toLowerCase();
  const list=members.filter(m=>!search||(m.name+m.phone+m.account+m.address).toLowerCase().includes(search)).sort((a,b)=>a.name.localeCompare(b.name,'ko'));
  document.getElementById('members-tbody').innerHTML=list.map((m,fi)=>{
    const i=members.indexOf(m);
    return `<tr><td style="color:var(--text3);">${i+1}</td><td><strong>${m.name}</strong></td><td style="font-family:'Space Mono',monospace;font-size:12px;">${m.phone||'-'}</td><td style="font-size:12px;color:var(--text3);">${m.ssn?m.ssn.slice(0,6)+'-*******':'-'}</td><td style="font-size:12px;">${m.account||'-'}</td><td><span class="rate-chip">${fmt(m.rate||10000)}ì›/h</span></td><td style="font-family:'Space Mono',monospace;font-size:13px;color:${m.pin?'var(--success)':'var(--danger)'}">${m.pin||'ë¯¸ì„¤ì •'}</td><td style="font-size:11px;color:var(--text2);max-width:180px;white-space:normal;">${m.address||'-'}</td><td><button class="btn btn-secondary btn-sm" onclick="openEditMember(${i})">ìˆ˜ì •</button><button class="btn btn-danger btn-sm" onclick="delMember(${i})" style="margin-left:4px;">ì‚­ì œ</button></td></tr>`;
  }).join('')||'<tr><td colspan="8" style="text-align:center;color:var(--text3);padding:24px;">ë“±ë¡ëœ ì¡°êµê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
}
function openAddMember(){
  editMemberIdx=null;
  document.getElementById('mm-title').textContent='ì¡°êµ ì¶”ê°€';
  ['mm-name','mm-phone','mm-ssn','mm-account','mm-address'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('mm-rate').value=10000;
  const mpinEl=document.getElementById('mm-pin');if(mpinEl)mpinEl.value='';
  document.getElementById('modal-member').classList.add('open');
}
function openEditMember(idx){
  editMemberIdx=idx;const m=members[idx];
  document.getElementById('mm-title').textContent='ì¡°êµ ì •ë³´ ìˆ˜ì •';
  document.getElementById('mm-name').value=m.name||'';
  document.getElementById('mm-phone').value=m.phone||'';
  document.getElementById('mm-ssn').value=m.ssn||'';
  document.getElementById('mm-rate').value=m.rate||10000;
  document.getElementById('mm-account').value=m.account||'';
  document.getElementById('mm-address').value=m.address||'';
  const mpinEl=document.getElementById('mm-pin');if(mpinEl)mpinEl.value=m.pin||'';
  document.getElementById('modal-member').classList.add('open');
}
function saveMember(){
  const name=document.getElementById('mm-name').value.trim();
  if(!name){alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  const entry={name,phone:document.getElementById('mm-phone').value,ssn:document.getElementById('mm-ssn').value,rate:parseFloat(document.getElementById('mm-rate').value)||10000,account:document.getElementById('mm-account').value,address:document.getElementById('mm-address').value,pin:(document.getElementById('mm-pin')?.value||'').trim()};
  mergeAndSaveMember(entry, editMemberIdx);
  fillNameSelects();renderAll();closeModal('modal-member');notif('ì¡°êµ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}
function delMember(idx){
  if(!confirm(`"${members[idx].name}" ì¡°êµë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  mergeAndDeleteMember(idx);fillNameSelects();renderAll();notif('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// â”€â”€â”€ SETTINGS â”€â”€â”€
function openSettings(){
  document.getElementById('sp-1').value='';document.getElementById('sp-2').value='';
  document.getElementById('sp-msg').textContent='';
  document.getElementById('s-tax').value=(taxRate*100).toFixed(1);
  document.getElementById('modal-settings').classList.add('open');
}
function saveSettings(){
  const p1=document.getElementById('sp-1').value,p2=document.getElementById('sp-2').value,msg=document.getElementById('sp-msg');
  if(p1||p2){
    if(p1!==p2){msg.style.color='var(--danger)';msg.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';return;}
    if(p1.length<4){msg.style.color='var(--danger)';msg.textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';return;}
    adminPw=p1;
  }
  const t=parseFloat(document.getElementById('s-tax').value);
  if(!isNaN(t)&&t>=0&&t<=100)taxRate=t/100;
  persist();closeModal('modal-settings');notif('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');renderAll();calcMamako();calculate();
}

// â”€â”€â”€ SIMPLE CALC â”€â”€â”€
function calculate(){
  const h=parseFloat(document.getElementById('c-hours').value)||0;
  const r=parseFloat(document.getElementById('c-rate').value)||10000;
  const before=Math.floor(h*r),tax=Math.floor(before*taxRate),net=before-tax;
  document.getElementById('c-before').textContent=fmt(before)+' ì›';
  document.getElementById('c-tax').textContent='-'+fmt(tax)+' ì›';
  document.getElementById('c-net').textContent=fmt(net)+' ì›';
  document.getElementById('c-rate-pct').textContent=(taxRate*100).toFixed(1);
}

// â”€â”€â”€ EXPORT â”€â”€â”€
function exportData(){
  const blob=new Blob([JSON.stringify({members,workReports,exportedAt:new Date().toISOString()},null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`ì¡°êµì •ì‚°_ë°ì´í„°_${new Date().toISOString().slice(0,10)}.json`;a.click();
  notif('ë°ì´í„°ê°€ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤');
}

// Firebase ì¤€ë¹„ ì™„ë£Œ í›„ init ì‹¤í–‰
window._afterInit = function(){
  // ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ (init ì™„ë£Œ í›„)
  document.getElementById('login-screen').style.display = 'flex';
};

// ë¡œê·¸ì¸ í™”ë©´ì„ ì²˜ìŒì—” ìˆ¨ê²¨ë†“ê³  init ì™„ë£Œ í›„ í‘œì‹œ
document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('login-screen').style.display = 'none';
  showLoadingOverlay(true);
  init();
});
</script>

<!-- EXPORT MODAL -->
<div class="modal-overlay" id="modal-export">
  <div class="modal">
    <div class="modal-header"><h3>ğŸ“Š ì—‘ì…€ íŒŒì¼ ë‚´ë³´ë‚´ê¸°</h3><button class="modal-close" onclick="closeModal(&#39;modal-export&#39;)">âœ•</button></div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text2);margin-bottom:20px;">ë‚´ë³´ë‚¼ ë‚´ìš©ì„ ì„ íƒí•˜ì„¸ìš”. ì„¸ë¬´ ì²˜ë¦¬ìš© í˜•ì‹ìœ¼ë¡œ ì •ë¦¬ë©ë‹ˆë‹¤.</p>
      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">
        <label style="display:flex;align-items:flex-start;gap:12px;cursor:pointer;text-transform:none;letter-spacing:0;padding:14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;">
          <input type="checkbox" id="ex-settlement" checked="" style="margin-top:2px;width:auto;padding:0;">
          <div><div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;">ğŸ“‹ ì›”ë³„ ì •ì‚°í˜„í™©</div><div style="font-size:12px;color:var(--text3);">ì´ë¦„, ì„¸ì „ê¸ˆì•¡, ê³µì œì•¡(3.3%), ì‹¤ì§€ê¸‰ì•¡, ê³„ì¢Œë²ˆí˜¸ â€” ì„¸ë¬´ ì‹ ê³ ìš©</div></div>
        </label>
        <label style="display:flex;align-items:flex-start;gap:12px;cursor:pointer;text-transform:none;letter-spacing:0;padding:14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;">
          <input type="checkbox" id="ex-worklog" checked="" style="margin-top:2px;width:auto;padding:0;">
          <div><div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;">ğŸ“ ì—…ë¬´ë‚´ì—­ ì „ì²´</div><div style="font-size:12px;color:var(--text3);">ë‚ ì§œ, ì´ë¦„, ìœ í˜•, ì‹œê°„, ì‹œê¸‰, ê¸ˆì•¡ â€” ì „ì²´ ì—…ë¬´ ê¸°ë¡</div></div>
        </label>
        <label style="display:flex;align-items:flex-start;gap:12px;cursor:pointer;text-transform:none;letter-spacing:0;padding:14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;">
          <input type="checkbox" id="ex-members" style="margin-top:2px;width:auto;padding:0;">
          <div><div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;">ğŸ‘¥ ì¸ì ì‚¬í•­ (ê°œì¸ì •ë³´ í¬í•¨)</div><div style="font-size:12px;color:var(--text3);">ì´ë¦„, ì£¼ë¯¼ë²ˆí˜¸, ê³„ì¢Œë²ˆí˜¸, ì‹œê¸‰, ì£¼ì†Œ â€” ë¯¼ê°ì •ë³´ ì£¼ì˜</div></div>
        </label>
      </div>
      <div style="display:flex;gap:12px;margin-bottom:12px;">
        <div class="form-group" style="flex:1;"><label>ê¸°ì¤€ ì—°ë„</label><select id="ex-year"></select></div>
        <div class="form-group" style="flex:1;"><label>ê¸°ì¤€ ì›”</label><select id="ex-month"><option value="all">ì „ì²´ (ì—°ê°„)</option></select></div>
      </div>
      <p style="font-size:11px;color:var(--text3);">* ì„ íƒí•œ ê¸°ê°„ì˜ ë°ì´í„°ë§Œ í¬í•¨ë©ë‹ˆë‹¤. ì‹œíŠ¸ë³„ë¡œ êµ¬ë¶„ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal(&#39;modal-export&#39;)">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="doExportXlsx()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>
</div>

<script src="./ì¡°êµ ì •ì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ_files/xlsx.full.min.js.ë‹¤ìš´ë¡œë“œ"></script>
<script>
function openExportModal(){
  const now=new Date();
  const ye=document.getElementById('ex-year');
  const me=document.getElementById('ex-month');
  ye.innerHTML='';
  for(let y=now.getFullYear();y>=now.getFullYear()-3;y--)
    ye.innerHTML+='<option value="'+y+'"'+(y===now.getFullYear()?' selected':'')+'>'+y+'ë…„</option>';
  me.innerHTML='<option value="all">ì „ì²´ (ì—°ê°„)</option>';
  for(let m=1;m<=12;m++)
    me.innerHTML+='<option value="'+m+'"'+(m===now.getMonth()+1?' selected':'')+'>'+m+'ì›”</option>';
  document.getElementById('modal-export').classList.add('open');
}

function doExportXlsx(){
  const year=document.getElementById('ex-year').value;
  const month=document.getElementById('ex-month').value;
  const doSett=document.getElementById('ex-settlement').checked;
  const doWork=document.getElementById('ex-worklog').checked;
  const doMemb=document.getElementById('ex-members').checked;
  if(!doSett&&!doWork&&!doMemb){alert('ë‚´ë³´ë‚¼ í•­ëª©ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.');return;}
  const prefix=month==='all'?year:(year+'-'+String(month).padStart(2,'0'));
  const periodLabel=month==='all'?(year+'ë…„ ì „ì²´'):(year+'ë…„ '+parseInt(month)+'ì›”');
  const wb=XLSX.utils.book_new();
  const QA_TYPE='mamako-qa';
  const tl={ta:'í˜„ì¥ì¡°êµ',lab:'ì—°êµ¬ì‹¤','mamako-online':'ë§ˆë§ˆì½”-ì˜¨ë¼ì¸','mamako-edit':'ë§ˆë§ˆì½”-ì˜¨ë¼ì¸','mamako-qa':'ì§ˆì˜ì‘ë‹µ','mamako-field':'í˜„ì¥ì¡°êµ',mamako:'ë§ˆë§ˆì½”-ì˜¨ë¼ì¸'};
  const taxPct='ì‚¬ì—…ì†Œë“ì„¸ '+(taxRate*100).toFixed(1)+'%(ì›)';
  const ts=new Date().toLocaleString('ko-KR');

  if(doSett){
    const list=workReports.filter(function(w){return w.date&&w.date.startsWith(prefix);});
    // ìœ í˜•ë³„ ì§‘ê³„
    // mamako-online: ê¸ˆì•¡ ì§‘ê³„ + ì„¸ë¶€(í”¼ë“œë°±/ì°¸ì—¬/ì§ˆë‹µ/ìˆ˜ì •/í˜„ì¥/ì—°êµ¬ì‹¤) í•©ì‚°
    // mamako-qa(ë…ë¦½): ê±´ìˆ˜ ì§‘ê³„
    // ta, lab, mamako-field: ì‹œê°„ ì§‘ê³„
    const map={};
    list.forEach(function(w){
      if(!map[w.name])map[w.name]={a:0, mamakoA:0, taH:0, labH:0, qaCount:0,
        fb:0, att:0, editH:0, mqaCount:0, fieldH:0, mLabH:0};
      var d=map[w.name], m=w.meta||{};
      d.a+=w.amount;
      if(w.type==='mamako-online'){
        d.mamakoA+=w.amount;
        d.fb+=(m.feedback||0); d.att+=(m.attend||0);
        d.editH+=(m.editH||0); d.mqaCount+=(m.qa||0);
        d.fieldH+=(m.fieldH||0); d.mLabH+=(m.labH||0);
      } else if(w.type===QA_TYPE){
        d.qaCount+=(m.qa||0);
      } else if(w.type==='ta'||w.type==='mamako-field'){
        d.taH+=(w.hours||0);
      } else if(w.type==='lab'){
        d.labH+=(w.hours||0);
      }
    });
    const rows=members.filter(function(m){return map[m.name];}).sort(function(a,b){return a.name.localeCompare(b.name,'ko');});
    const hasMamako=list.some(function(w){return w.type==='mamako-online';});
    const hasTA=list.some(function(w){return w.type==='ta'||w.type==='mamako-field';});
    const hasLab=list.some(function(w){return w.type==='lab';});
    const hasQA=list.some(function(w){return w.type===QA_TYPE;});
    // í—¤ë” êµ¬ì„±
    const header=['ìˆœë²ˆ','ì´ë¦„'];
    if(hasMamako) header.push('ë§ˆë§ˆì½”(ì›)','â””í”¼ë“œë°±(ê±´)','â””ì°¸ì—¬(íšŒ)','â””ìˆ˜ì •/ê²Œì‹œ(h)','â””ì§ˆë‹µ(ê±´)','â””í˜„ì¥(h)','â””ì—°êµ¬ì‹¤(h)');
    if(hasTA)  header.push('í˜„ì¥ì¡°êµ(h)');
    if(hasLab) header.push('ì—°êµ¬ì‹¤(h)');
    if(hasQA)  header.push('ì§ˆì˜ì‘ë‹µ(ê±´)');
    header.push('ì„¸ì „ ê¸ˆì•¡(ì›)',taxPct,'ì‹¤ì§€ê¸‰ì•¡(ì›)','ì…ê¸ˆ ê³„ì¢Œ');
    const data=[['ì •ì‚°í˜„í™© â€” '+periodLabel],['ìƒì„±ì¼ì‹œ: '+ts],[],header];
    var tb=0,tt=0,tn=0;
    rows.forEach(function(m,i){
      var d=map[m.name],tax=Math.floor(d.a*taxRate),net=d.a-tax;
      tb+=d.a;tt+=tax;tn+=net;
      var row=[i+1,m.name];
      if(hasMamako) row.push(d.mamakoA||0, d.fb||0, d.att||0, d.editH||0, d.mqaCount||0, d.fieldH||0, d.mLabH||0);
      if(hasTA)  row.push(d.taH||0);
      if(hasLab) row.push(d.labH||0);
      if(hasQA)  row.push(d.qaCount||0);
      row.push(d.a,tax,net,m.account||'');
      data.push(row);
    });
    var sumRow=['','í•©ê³„'];
    if(hasMamako){var totM=rows.reduce(function(s,m){return s+(map[m.name].mamakoA||0);},0);sumRow.push(totM,'','','','','','');}
    if(hasTA){var totT=rows.reduce(function(s,m){return s+(map[m.name].taH||0);},0);sumRow.push(totT);}
    if(hasLab){var totL=rows.reduce(function(s,m){return s+(map[m.name].labH||0);},0);sumRow.push(totL);}
    if(hasQA){var totQ=rows.reduce(function(s,m){return s+(map[m.name].qaCount||0);},0);sumRow.push(totQ);}
    sumRow.push(tb,tt,tn,'');
    data.push([],sumRow);
    const ws=XLSX.utils.aoa_to_sheet(data);
    var cols=[{wch:6},{wch:12}];
    if(hasMamako) cols=cols.concat([{wch:14},{wch:10},{wch:10},{wch:12},{wch:10},{wch:10},{wch:10}]);
    if(hasTA)  cols.push({wch:12});
    if(hasLab) cols.push({wch:12});
    if(hasQA)  cols.push({wch:14});
    cols=cols.concat([{wch:16},{wch:22},{wch:14},{wch:32}]);
    ws['!cols']=cols;
    ws['!merges']=[{s:{r:0,c:0},e:{r:0,c:header.length-1}}];
    XLSX.utils.book_append_sheet(wb,ws,'ì •ì‚°í˜„í™©');
  }

  if(doWork){
    var list2=workReports.filter(function(w){return w.date&&w.date.startsWith(prefix);});
    // ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ â†’ ê°™ì€ ì´ë¦„ì€ ë‚ ì§œìˆœ
    list2.sort(function(a,b){
      var nc=a.name.localeCompare(b.name,'ko');
      return nc!==0?nc:a.date.localeCompare(b.date);
    });
    const data2=[['ì—…ë¬´ë‚´ì—­ â€” '+periodLabel],['ìƒì„±ì¼ì‹œ: '+ts],[],
      ['ë‚ ì§œ','ì´ë¦„','ì—…ë¬´ìœ í˜•','ìƒì„¸ë‚´ìš©',
       'í”¼ë“œë°±(ê±´)','ì°¸ì—¬(íšŒ)','ìˆ˜ì •/ê²Œì‹œ(h)','ì§ˆë‹µ(ê±´)','í˜„ì¥(h)','í˜„ì¥ì‹œê¸‰','ì—°êµ¬ì‹¤(h)','ì—°êµ¬ì‹¤ì‹œê¸‰',
       'ì´ì‹œê°„(h)','ì„¸ì „ê¸ˆì•¡(ì›)','ì„¸í›„ê¸ˆì•¡(ì›)','ë¹„ê³ ']];
    list2.forEach(function(w){
      var m=w.meta||{};
      if(w.type==='mamako-online'){
        data2.push([
          w.date, w.name, tl[w.type]||w.type, w.detail||'',
          m.feedback||0, m.attend||0, m.editH||0, m.qa||0,
          m.fieldH||0, m.fieldH?(m.fieldR||10000):'-',
          m.labH||0,   m.labH?(m.labR||10000):'-',
          w.hours||0,
          w.amount, Math.floor(w.amount*(1-taxRate)), w.note||''
        ]);
      } else if(w.type===QA_TYPE){
        data2.push([
          w.date, w.name, tl[w.type]||w.type, w.detail||'',
          '-','-','-', m.qa||0, '-','-','-','-',
          '-',
          w.amount, Math.floor(w.amount*(1-taxRate)), w.note||''
        ]);
      } else {
        data2.push([
          w.date, w.name, tl[w.type]||w.type, w.detail||'',
          '-','-','-','-','-','-','-','-',
          w.hours||0,
          w.amount, Math.floor(w.amount*(1-taxRate)), w.note||''
        ]);
      }
    });
    var tb2=list2.reduce(function(s,w){return s+w.amount;},0);
    data2.push([],['','','','','','','','','','','','','í•©ê³„',tb2,Math.floor(tb2*(1-taxRate)),'']);
    const ws2=XLSX.utils.aoa_to_sheet(data2);
    ws2['!cols']=[{wch:12},{wch:10},{wch:18},{wch:32},
      {wch:10},{wch:10},{wch:12},{wch:10},{wch:10},{wch:10},{wch:10},{wch:10},
      {wch:10},{wch:16},{wch:16},{wch:16}];
    ws2['!merges']=[{s:{r:0,c:0},e:{r:0,c:15}}];
    XLSX.utils.book_append_sheet(wb,ws2,'ì—…ë¬´ë‚´ì—­');
  }

  if(doMemb){
    const data3=[['ì¸ì ì‚¬í•­ ë§ˆìŠ¤í„° â€” ê¸°ë°€'],['ìƒì„±ì¼ì‹œ: '+ts],[],['ìˆœë²ˆ','ì´ë¦„','í•¸ë“œí°','ì£¼ë¯¼ë²ˆí˜¸','ì‹œê¸‰(ì›/h)','ê³„ì¢Œë²ˆí˜¸','ì£¼ì†Œ']];
    [...members].sort(function(a,b){return a.name.localeCompare(b.name,'ko');}).forEach(function(m,i){data3.push([i+1,m.name,m.phone||'',m.ssn||'',m.rate||10000,m.account||'',m.address||'']);});
    const ws3=XLSX.utils.aoa_to_sheet(data3);
    ws3['!cols']=[{wch:6},{wch:10},{wch:16},{wch:18},{wch:12},{wch:30},{wch:42}];
    ws3['!merges']=[{s:{r:0,c:0},e:{r:0,c:6}}];
    XLSX.utils.book_append_sheet(wb,ws3,'ì¸ì ì‚¬í•­');
  }

  XLSX.writeFile(wb,'ì¡°êµì •ì‚°_'+periodLabel+'_'+new Date().toISOString().slice(0,10)+'.xlsx');
  closeModal('modal-export');
  notif('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
}

function exportSettlementXlsx(){
  const year=document.getElementById('sy').value;
  const month=String(document.getElementById('sm').value).padStart(2,'0');
  const prefix=year+'-'+month;
  const periodLabel=year+'ë…„ '+parseInt(month)+'ì›”';
  const list=workReports.filter(function(w){return w.date&&w.date.startsWith(prefix);});
  const ts=new Date().toLocaleString('ko-KR');

  // ìœ í˜• ê·¸ë£¹ ì •ì˜
  // ì—°êµ¬ì‹¤ = lab
  // ë§ˆë§ˆì½” = mamako-online, mamako-qa, mamako-edit
  // ì¡°êµ   = ta, mamako-field
  const isLab    = function(t){return t==='lab';};
  const isMamako = function(t){return t==='mamako-online'||t==='mamako-qa'||t==='mamako-edit'||t==='mamako';};
  const isTa     = function(t){return t==='ta'||t==='mamako-field';};

  // ì¡°êµë³„ ê¸ˆì•¡ ì§‘ê³„
  const map={};
  list.forEach(function(w){
    if(!map[w.name])map[w.name]={lab:0,mamako:0,ta:0};
    if(isLab(w.type))    map[w.name].lab    += w.amount;
    else if(isMamako(w.type)) map[w.name].mamako += w.amount;
    else if(isTa(w.type))     map[w.name].ta     += w.amount;
  });

  // í—¤ë”
  const header=[
    'ì´ë¦„','ì£¼ë¯¼ë²ˆí˜¸','í•¸ë“œí°','ê³„ì¢Œ ë²ˆí˜¸',
    'ì—°êµ¬ì‹¤ ì •ì‚°','ì—°êµ¬ì‹¤ 3.3%',
    'ë§ˆë§ˆì½” ì •ì‚°','ë§ˆë§ˆì½” 3.3%',
    'ì¡°êµ ì •ì‚°','ì¡°êµ 3.3%',
    'ì—°êµ¬ì‹¤&ë§ˆë§ˆì½”&ì¡°êµ í•©ì‚°','ë¹„ê³ '
  ];
  const data=[['ì •ì‚°í˜„í™© â€” '+periodLabel],['ìƒì„±ì¼ì‹œ: '+ts],[],header];

  // ì „ì²´ ì¡°êµ ëª©ë¡ (ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ)
  const sorted=[...members].sort(function(a,b){return a.name.localeCompare(b.name,'ko');});
  var totalNet=0;
  sorted.forEach(function(m){
    const d=map[m.name]||{lab:0,mamako:0,ta:0};
    const labTax   = Math.floor(d.lab    * taxRate);
    const mamakoTax= Math.floor(d.mamako * taxRate);
    const taTax    = Math.floor(d.ta     * taxRate);
    const net=(d.lab-labTax)+(d.mamako-mamakoTax)+(d.ta-taTax);
    totalNet+=net;

    const fmt=function(v){return v>0?v:'-';};
    const fmtT=function(v){return v>0?v:'-';};
    data.push([
      m.name,
      m.ssn  ? m.ssn.slice(0,6)+'-'+(m.ssn.slice(6)||'*******') : '-',
      m.phone||'-',
      m.account||'-',
      fmt(d.lab),    fmtT(labTax>0?labTax:0)||'-',
      fmt(d.mamako), fmtT(mamakoTax>0?mamakoTax:0)||'-',
      fmt(d.ta),     fmtT(taTax>0?taTax:0)||'-',
      net>0?net:'-',
      ''
    ]);
  });

  // í•©ê³„í–‰
  var totLab=0,totMamako=0,totTa=0;
  sorted.forEach(function(m){
    const d=map[m.name]||{lab:0,mamako:0,ta:0};
    totLab+=d.lab; totMamako+=d.mamako; totTa+=d.ta;
  });
  data.push([]);
  data.push([
    'í•©ê³„','','','',
    totLab||'-', totLab?Math.floor(totLab*taxRate):'-',
    totMamako||'-', totMamako?Math.floor(totMamako*taxRate):'-',
    totTa||'-', totTa?Math.floor(totTa*taxRate):'-',
    totalNet||'-', ''
  ]);

  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(data);
  ws['!cols']=[
    {wch:10},{wch:18},{wch:16},{wch:32},
    {wch:12},{wch:12},
    {wch:12},{wch:12},
    {wch:12},{wch:12},
    {wch:18},{wch:16}
  ];
  ws['!merges']=[{s:{r:0,c:0},e:{r:0,c:11}}];
  XLSX.utils.book_append_sheet(wb,ws,'ì •ì‚°í˜„í™©');
  XLSX.writeFile(wb,'ì •ì‚°í˜„í™©_'+periodLabel+'.xlsx');
  notif('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
}
</script>


<div id="fb-loading" style="position: fixed; inset: 0px; background: rgba(13, 15, 20, 0.92); display: none; align-items: center; justify-content: center; z-index: 9999; font-family: &quot;Noto Sans KR&quot;, sans-serif; flex-direction: column; gap: 14px;"><div style="width:36px;height:36px;border:3px solid #2a2f3d;border-top-color:#4f8ef7;border-radius:50%;animation:spin .8s linear infinite;"></div><div style="color:#8b91a7;font-size:13px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div><style>@keyframes spin{to{transform:rotate(360deg)}}</style></div></body></html>